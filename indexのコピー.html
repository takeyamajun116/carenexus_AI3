<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CareNexus AI - Electronic Medical Record Integrated</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* =========================================
       CSS: CareNexus AI Base Design
       ========================================= */
    :root {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      color: #111827;
      background: #f3f4f6;
    }
    body {
      margin: 0;
      background: #f3f4f6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* Header */
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(16px);
      background: rgba(243, 244, 246, 0.95);
      border-bottom: 1px solid #e5e7eb;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .logo {
      font-weight: 700;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 6px;
      color: #1f2937;
    }
    .header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }
    .badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }
    .user-info {
      font-size: 12px;
      color: #6b7280;
    }

    /* Layout Containers */
    .app-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
      width: 100%;
      box-sizing: border-box;
    }

    /* Navigation Tabs */
    .tabs {
      display: flex;
      border-radius: 8px;
      background: #e5e7eb;
      padding: 4px;
      margin-bottom: 16px;
      overflow-x: auto;
      gap: 4px;
    }
    .tab {
      flex: 1;
      text-align: center;
      padding: 8px 0;
      font-size: 13px;
      border-radius: 6px;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
      min-width: 70px;
      color: #6b7280;
      transition: all 0.2s;
    }
    .tab.active {
      background: #ffffff;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      font-weight: 600;
      color: #111827;
    }

    /* View Sections */
    .section {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    .section.active {
      display: block;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Column Layouts */
    .two-column {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    @media (min-width: 900px) {
      .two-column { flex-direction: row; }
    }
    .panel {
      flex: 1;
      border-radius: 12px;
      background: #ffffff;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      margin-bottom: 12px;
      border: 1px solid #e5e7eb;
    }
    .panel-title {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #f3f4f6;
      padding-bottom: 8px;
      color: #111827;
    }

    /* UI Elements: Buttons, Inputs */
    .btn {
      border-radius: 6px;
      border: none;
      padding: 8px 16px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      transition: opacity 0.2s;
    }
    .btn:hover { opacity: 0.9; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-primary { background: #2563eb; color: #ffffff; }
    .btn-outline { background: #ffffff; color: #374151; border: 1px solid #d1d5db; }
    .btn-danger { background: #fee2e2; color: #991b1b; }
    
    input, select, textarea {
      width: 100%;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      padding: 10px;
      box-sizing: border-box;
      font-family: inherit;
      margin-top: 4px;
      background: #fff;
    }
    textarea { min-height: 80px; resize: vertical; }
    .field-label {
      font-size: 12px;
      color: #4b5563;
      margin-top: 12px;
      margin-bottom: 4px;
      font-weight: 600;
      display: block;
    }

    /* Lists & Tables */
    .visit-list { display: flex; flex-direction: column; gap: 10px; }
    .visit-card {
      padding: 12px;
      border-radius: 8px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      cursor: pointer;
      transition: background 0.2s;
    }
    .visit-card:hover { background: #f3f4f6; }
    
    .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 600; margin-left: 6px; }
    .tag-red { background: #fee2e2; color: #991b1b; }
    .tag-blue { background: #dbeafe; color: #1e40af; }
    .tag-gray { background: #e5e7eb; color: #374151; }

    .vital-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 8px; }
    .vital-table th, .vital-table td { border: 1px solid #e5e7eb; padding: 8px; text-align: center; }
    .vital-table th { background: #f9fafb; }

    /* AI Typing Effect */
    .ai-result-box {
      background: #f9fafb;
      padding: 12px;
      border-radius: 6px;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
      border: 1px solid #e5e7eb;
      color: #374151;
      min-height: 60px;
      position: relative;
    }
    .typing::after {
      content: '|';
      animation: blink 1s infinite;
      color: #2563eb;
    }
    @keyframes blink { 50% { opacity: 0; } }

    /* Map (Demo) */
    .map-container {
      position: relative;
      width: 100%;
      height: 200px;
      border-radius: 8px;
      background: #eff6ff;
      overflow: hidden;
      border: 1px solid #dbeafe;
      margin-bottom: 12px;
    }
    .map-marker {
      position: absolute;
      transform: translate(-50%, -50%);
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      font-weight: bold;
      border: 1px solid rgba(0,0,0,0.1);
      cursor: pointer;
      white-space: nowrap;
    }
    .marker-patient { background: #fee2e2; color: #991b1b; }
  </style>
</head>
<body>

<header>
  <div class="logo">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
    </svg>
    <span>CareNexus AI</span>
  </div>
  <div class="header-right">
    <div class="badge">Integrated Edition</div>
    <div class="user-info" id="currentUserDisplay">Not Logged In</div>
  </div>
</header>

<div class="app-container">
  
  <div class="tabs">
    <div class="tab active" onclick="showView('dashboard')">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
    <div class="tab" onclick="showView('patients')">åˆ©ç”¨è€…ä¸€è¦§</div>
    <div class="tab" onclick="showView('record')">è¨˜éŒ²ãƒ»AIä½œæˆ</div>
    <div class="tab" onclick="showView('settings')">è¨­å®šãƒ»ç®¡ç†</div>
  </div>

  <div id="view-dashboard" class="section active">
    <div class="two-column">
      <div class="panel" style="flex: 2;">
        <div class="panel-title">
          <span>æœ¬æ—¥ã®è¨ªå•äºˆå®š</span>
          <span class="badge" id="todayDateDisplay"></span>
        </div>
        <div id="dashboard-visit-list" class="visit-list">
          </div>
      </div>
      <div class="panel" style="flex: 1;">
        <div class="panel-title">åœ°åŸŸãƒãƒƒãƒ— (ãƒ‡ãƒ¢)</div>
        <div class="map-container" id="mapContainer">
          </div>
        <div class="panel-title" style="margin-top:12px;">é€šçŸ¥ãƒ»é€£æº</div>
        <div class="visit-card" style="font-size:12px; color:#555;">
          <strong>Dr. ä½è—¤ (é€£æºåŒ»)</strong> <span style="float:right; color:#999;">10:30</span><br>
          ç”°ä¸­æ§˜ã®è¡€ç³–å€¤å¤‰å‹•ã«ã¤ã„ã¦ã€ã‚¤ãƒ³ã‚¹ãƒªãƒ³å˜ä½ã®å¤‰æ›´ã‚’æ¤œè¨ã—ã¦ã„ã¾ã™ã€‚
        </div>
      </div>
    </div>
  </div>

  <div id="view-patients" class="section">
    <div class="panel">
      <div class="panel-title">
        åˆ©ç”¨è€…æ¤œç´¢
        <button class="btn btn-primary" onclick="showAddPatientModal()">ï¼‹ æ–°è¦ç™»éŒ²</button>
      </div>
      <input type="text" id="patient-search" placeholder="åå‰ã§æ¤œç´¢..." onkeyup="renderPatientsList()" style="margin-bottom:12px;">
      <div style="overflow-x:auto;">
        <table class="vital-table" style="text-align:left;">
          <thead>
            <tr>
              <th>æ°å</th>
              <th>å¹´é½¢/æ€§åˆ¥</th>
              <th>è¦ä»‹è­·åº¦</th>
              <th>è¨ºæ–­å</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="patient-list-tbody">
            </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="view-record" class="section">
    <div class="two-column">
      <div class="panel" style="flex: 1;">
        <div class="panel-title">å¯¾è±¡åˆ©ç”¨è€…é¸æŠ</div>
        <select id="record-patient-select" onchange="onRecordPatientChange()" style="margin-bottom:12px;">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
        
        <div id="record-patient-info" style="display:none;">
          <div style="background:#f9fafb; padding:10px; border-radius:6px; font-size:12px; margin-bottom:12px;">
            <div id="p-info-basic" style="font-weight:bold; font-size:14px; margin-bottom:4px;"></div>
            <div id="p-info-detail" style="color:#555;"></div>
          </div>
          
          <div class="panel-title">ãƒã‚¤ã‚¿ãƒ«æ¨ç§»</div>
          <div style="height:150px; width:100%;">
            <canvas id="vitalsChartMini"></canvas>
          </div>

          <div class="panel-title" style="margin-top:16px;">éå»ã®è¨˜éŒ²</div>
          <div id="record-history-list" class="visit-list" style="max-height:300px; overflow-y:auto;"></div>
        </div>
      </div>

      <div class="panel" style="flex: 2;">
        <div class="panel-title">
          <span id="record-form-title">è¨ªå•è¨˜éŒ²å…¥åŠ›</span>
          <div>
            <button class="btn btn-outline" type="button" onclick="startVoiceDemo()">ğŸ¤ éŸ³å£°å…¥åŠ›ãƒ‡ãƒ¢</button>
            <button class="btn btn-primary" type="button" onclick="generateAIReport()">âœ¨ AIç”Ÿæˆ</button>
          </div>
        </div>

        <form id="visit-record-form" onsubmit="saveVisitRecord(event)">
          <input type="hidden" id="rec-visit-id">
          
          <div style="display:flex; gap:12px;">
            <div style="flex:1;">
              <span class="field-label">æ—¥ä»˜</span>
              <input type="date" id="rec-date" required>
            </div>
            <div style="flex:1;">
              <span class="field-label">æ™‚é–“</span>
              <div style="display:flex; gap:4px;">
                <input type="time" id="rec-time-start" required>
                <span style="align-self:center;">~</span>
                <input type="time" id="rec-time-end">
              </div>
            </div>
          </div>

          <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:8px; margin-top:12px;">
            <div><span class="field-label">ä½“æ¸©</span><input type="number" step="0.1" id="rec-temp" placeholder="â„ƒ"></div>
            <div><span class="field-label">è¡€åœ§(ä¸Š)</span><input type="number" id="rec-bp-sys" placeholder="mmHg"></div>
            <div><span class="field-label">è¡€åœ§(ä¸‹)</span><input type="number" id="rec-bp-dia" placeholder="mmHg"></div>
            <div><span class="field-label">SpO2</span><input type="number" id="rec-spo2" placeholder="%"></div>
          </div>

          <div style="margin-top:16px; border-top:1px dashed #e5e7eb; padding-top:12px;">
            <span class="field-label">ç”Ÿæˆãƒ—ãƒ­ã‚»ã‚¹ / çŠ¶æ³ãƒ¡ãƒ¢ (AIå…¥åŠ›å…ƒ)</span>
            <textarea id="rec-raw-input" placeholder="ã“ã“ã«ç®‡æ¡æ›¸ãã‚„éŸ³å£°èªè­˜ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã™ã‚‹ã¨ã€AIãŒä¸‹ã®SOAPã‚’ç”Ÿæˆã—ã¾ã™..." style="height:60px;"></textarea>
          </div>

          <div class="field-label" style="margin-top:12px; color:#2563eb;">SOAPè¨˜éŒ² (AIç”Ÿæˆå¯¾è±¡)</div>
          <textarea id="rec-soap" style="height:150px; font-family:monospace;" placeholder="ã“ã“ã«AIç”ŸæˆçµæœãŒå‡ºåŠ›ã•ã‚Œã¾ã™"></textarea>
          
          <div style="margin-top:16px; text-align:right;">
            <button type="button" class="btn btn-outline" onclick="clearRecordForm()">ã‚¯ãƒªã‚¢</button>
            <button type="submit" class="btn btn-primary">ä¿å­˜ã—ã¦å®Œäº†</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="view-settings" class="section">
    <div class="panel">
      <div class="panel-title">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
      <p style="font-size:13px; color:#666;">
        ã“ã®ãƒ‡ãƒ¢ã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶(localStorage)ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚
        ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã¦ã‚‚ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã•ã‚Œã¾ã™ãŒã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ã¨æ¶ˆãˆã¾ã™ã€‚
      </p>
      <button class="btn btn-danger" onclick="resetAllData()">ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–(ãƒ‡ãƒ¢ç”¨ãƒªã‚»ãƒƒãƒˆ)</button>
    </div>
  </div>

</div>

<script>
/**
 * =============================================================================
 * 1. DATA MODEL & STORAGE (é›»å­ã‚«ãƒ«ãƒ†ã‚³ãƒ¼ãƒ‰ç›¸å½“)
 * =============================================================================
 */
const STORAGE_KEY = "carenexus_integrated_v1";

// åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼ˆåˆå›èµ·å‹•æ™‚ã®ã¿ä½¿ç”¨ï¼‰
function createInitialState() {
  const p1 = "pat-001"; // ç”°ä¸­ å¤ªéƒ
  const p2 = "pat-002"; // ä½è—¤ èŠ±å­
  const now = new Date();
  
  return {
    currentUser: { name: "Ns. å±±ç”°", role: "admin" },
    patients: [
      { id: p1, lastName: "ç”°ä¸­", firstName: "å¤ªéƒ", age: 82, sex: "M", address: "æ±äº¬éƒ½ä¸–ç”°è°·åŒº1-1", care: "è¦ä»‹è­·3", diag: "ç³–å°¿ç—…ã€é«˜è¡€åœ§", loc:{x:30,y:40} },
      { id: p2, lastName: "ä½è—¤", firstName: "èŠ±å­", age: 75, sex: "F", address: "æ±äº¬éƒ½ä¸–ç”°è°·åŒº2-5", care: "è¦ä»‹è­·1", diag: "æ…¢æ€§å¿ƒä¸å…¨", loc:{x:60,y:70} }
    ],
    // è¨ªå•äºˆå®šã¨å±¥æ­´
    visits: [
      { 
        id: "v-1", 
        patientId: p1, 
        startAt: new Date(now.getFullYear(), now.getMonth(), now.getDate(), 9, 30).toISOString(), 
        type: "regular", 
        status: "completed", 
        soap: "S: è¶³ã®ã‚€ãã¿ãŒæ°—ã«ãªã‚‹\nO: BP138/84, KT36.5\nA: æœè–¬ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹è‰¯å¥½\nP: æ¬¡å›æ¡è¡€äºˆå®š" 
      },
      { 
        id: "v-2", 
        patientId: p2, 
        startAt: new Date(now.getFullYear(), now.getMonth(), now.getDate(), 13, 0).toISOString(), 
        type: "regular", 
        status: "scheduled", 
        soap: "" 
      }
    ],
    // ãƒã‚¤ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿
    vitals: [
      { patientId: p1, measuredAt: new Date(now.getTime() - 86400000).toISOString(), temp: 36.5, bpSys: 138, bpDia: 84, spo2: 96 },
      { patientId: p1, measuredAt: new Date(now.getTime() - 172800000).toISOString(), temp: 36.8, bpSys: 142, bpDia: 88, spo2: 95 },
      { patientId: p2, measuredAt: new Date(now.getTime() - 86400000).toISOString(), temp: 36.2, bpSys: 110, bpDia: 70, spo2: 98 }
    ]
  };
}

// ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ãƒ»ä¿å­˜
let appState = loadState();

function loadState() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return createInitialState();
  try {
    return JSON.parse(raw);
  } catch(e) {
    return createInitialState();
  }
}

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
}

function resetAllData() {
  if(confirm("å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ")) {
    appState = createInitialState();
    saveState();
    location.reload();
  }
}

// ç°¡æ˜“IDç”Ÿæˆ
function genId() { return Math.random().toString(36).substr(2, 9); }


/**
 * =============================================================================
 * 2. UI CONTROL & VIEW LOGIC (CareNexus UIé€£æº)
 * =============================================================================
 */
let currentView = "dashboard";
let currentPatientId = null;
let vitalsChart = null; // Chart.jsã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¿æŒç”¨

// ã‚¢ãƒ—ãƒªåˆæœŸåŒ–
document.addEventListener("DOMContentLoaded", () => {
  updateHeader();
  showView("dashboard"); // åˆæœŸè¡¨ç¤º
});

function updateHeader() {
  document.getElementById("currentUserDisplay").textContent = appState.currentUser ? appState.currentUser.name : "Guest";
  const d = new Date();
  document.getElementById("todayDateDisplay").textContent = `${d.getMonth()+1}/${d.getDate()}`;
}

// ç”»é¢åˆ‡ã‚Šæ›¿ãˆç®¡ç†
function showView(viewId) {
  currentView = viewId;
  
  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºåˆ‡æ›¿
  document.querySelectorAll(".section").forEach(el => el.classList.remove("active"));
  document.getElementById(`view-${viewId}`).classList.add("active");
  
  // ã‚¿ãƒ–ã®ActiveçŠ¶æ…‹æ›´æ–°
  document.querySelectorAll(".tab").forEach(el => el.classList.remove("active"));
  const tabIds = ["dashboard", "patients", "record", "settings"];
  const idx = tabIds.indexOf(viewId);
  if(idx >= 0) {
    document.querySelectorAll(".tab")[idx].classList.add("active");
  }

  // å„ç”»é¢ã®åˆæœŸåŒ–é–¢æ•°å‘¼ã³å‡ºã—
  if (viewId === "dashboard") renderDashboard();
  if (viewId === "patients") renderPatientsList();
  if (viewId === "record") initRecordView();
}


/* --- Dashboard Logic --- */
function renderDashboard() {
  const listEl = document.getElementById("dashboard-visit-list");
  listEl.innerHTML = "";
  
  // ä»Šæ—¥ã®æ—¥ä»˜ã®è¨ªå•ã‚’æŠ½å‡º
  const todayStr = new Date().toISOString().slice(0,10);
  // å…¨è¨ªå•ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ä»Šæ—¥é–‹å§‹ã®ã‚‚ã®ãƒ•ã‚£ãƒ«ã‚¿ã—ã€æ™‚é–“é †ã‚½ãƒ¼ãƒˆ
  const todaysVisits = appState.visits
    .filter(v => v.startAt.startsWith(todayStr))
    .sort((a,b) => new Date(a.startAt) - new Date(b.startAt));

  if (todaysVisits.length === 0) {
    listEl.innerHTML = `<div style="color:#999; text-align:center; padding:20px;">æœ¬æ—¥ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
  }

  todaysVisits.forEach(v => {
    const p = appState.patients.find(p => p.id === v.patientId);
    if (!p) return;
    
    const timeStr = new Date(v.startAt).toTimeString().slice(0,5);
    const div = document.createElement("div");
    div.className = "visit-card";
    
    // å®Œäº†/äºˆå®šã®ã‚¿ã‚°è‰²åˆ†ã‘
    const statusLabel = v.status === 'completed' ? 'å®Œäº†' : 'äºˆå®š';
    const tagClass = v.status === 'completed' ? 'tag-gray' : 'tag-red';

    div.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <span style="font-weight:bold; font-size:14px;">${timeStr} - ${p.lastName} ${p.firstName} æ§˜</span>
        <span class="tag ${tagClass}">${statusLabel}</span>
      </div>
      <div style="font-size:12px; color:#666; margin-top:4px;">
        ${p.address} | ${p.care}
      </div>
    `;
    div.onclick = () => {
      // ã‚¯ãƒªãƒƒã‚¯ã§è¨˜éŒ²ç”»é¢ã¸ã‚¸ãƒ£ãƒ³ãƒ—
      showView("record");
      // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³æ›´æ–°å¾Œã«é¸æŠ
      setTimeout(() => {
        const sel = document.getElementById("record-patient-select");
        sel.value = p.id;
        onRecordPatientChange();
      }, 50);
    };
    listEl.appendChild(div);
  });

  renderMap();
}

// ç°¡æ˜“ãƒãƒƒãƒ—æç”»
function renderMap() {
  const el = document.getElementById("mapContainer");
  // èƒŒæ™¯ã‚°ãƒªãƒƒãƒ‰
  el.innerHTML = '<div style="position:absolute; inset:0; background: radial-gradient(#d1d5db 1px, transparent 1px); background-size: 20px 20px; opacity:0.4;"></div>';
  
  appState.patients.forEach(p => {
    if(!p.loc) return;
    const m = document.createElement("div");
    m.className = "map-marker marker-patient";
    // åº§æ¨™ã¯ï¼…æŒ‡å®š(ãƒ‡ãƒ¢ç”¨)
    m.style.left = p.loc.x + "%";
    m.style.top = p.loc.y + "%";
    m.textContent = p.lastName;
    el.appendChild(m);
  });
}


/* --- Patients List Logic --- */
function renderPatientsList() {
  const tbody = document.getElementById("patient-list-tbody");
  tbody.innerHTML = "";
  const filterText = document.getElementById("patient-search").value.toLowerCase();

  appState.patients.forEach(p => {
    const fullName = p.lastName + p.firstName;
    if (filterText && !fullName.includes(filterText)) return;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="font-weight:bold;">${p.lastName} ${p.firstName}</td>
      <td>${p.age}æ­³ / ${p.sex}</td>
      <td>${p.care}</td>
      <td style="font-size:11px;">${p.diag}</td>
      <td><button class="btn btn-outline" style="padding:2px 8px; font-size:11px;" onclick="goToRecord('${p.id}')">è¨˜éŒ²</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function showAddPatientModal() {
  alert("ãƒ‡ãƒ¢ç‰ˆã®ãŸã‚ã€æ–°è¦ç™»éŒ²æ©Ÿèƒ½ã¯çœç•¥ã•ã‚Œã¦ã„ã¾ã™ã€‚");
}

function goToRecord(pid) {
  showView("record");
  setTimeout(() => {
    const sel = document.getElementById("record-patient-select");
    sel.value = pid;
    onRecordPatientChange();
  }, 50);
}


/* --- Record / AI Logic --- */
function initRecordView() {
  const sel = document.getElementById("record-patient-select");
  // é¸æŠè‚¢ã‚’å†ç”Ÿæˆï¼ˆé‡è¤‡å›é¿ã®ãŸã‚ä¸€åº¦ç©ºã«ã™ã‚‹æ‰‹ã‚‚ã‚ã‚‹ãŒã€ã“ã“ã§ã¯è¿½åŠ ãƒã‚§ãƒƒã‚¯ï¼‰
  if(sel.options.length <= 1) {
    appState.patients.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = `${p.lastName} ${p.firstName} (${p.age}æ­³)`;
      sel.appendChild(opt);
    });
  }
  
  // æ—¥ä»˜ã®åˆæœŸå€¤ã‚’ä»Šæ—¥ã«
  document.getElementById("rec-date").valueAsDate = new Date();
  document.getElementById("rec-time-start").value = new Date().toTimeString().slice(0,5);
}

// åˆ©ç”¨è€…é¸æŠæ™‚ã®å‡¦ç†
function onRecordPatientChange() {
  const pid = document.getElementById("record-patient-select").value;
  currentPatientId = pid;
  const p = appState.patients.find(x => x.id === pid);
  
  const infoDiv = document.getElementById("record-patient-info");
  
  if (!p) {
    infoDiv.style.display = "none";
    clearRecordForm();
    return;
  }

  // åŸºæœ¬æƒ…å ±è¡¨ç¤º
  infoDiv.style.display = "block";
  document.getElementById("p-info-basic").textContent = `${p.lastName} ${p.firstName} (${p.age}æ­³ / ${p.sex})`;
  document.getElementById("p-info-detail").textContent = `ä½æ‰€: ${p.address} | ç—…å: ${p.diag}`;

  // ã‚°ãƒ©ãƒ•æ›´æ–°
  renderMiniChart(pid);

  // éå»ã®è¨˜éŒ²å±¥æ­´ã‚’è¡¨ç¤º
  const histEl = document.getElementById("record-history-list");
  histEl.innerHTML = "";
  const visits = appState.visits
    .filter(v => v.patientId === pid)
    .sort((a,b) => new Date(b.startAt) - new Date(a.startAt)); // æ–°ã—ã„é †
    
  visits.forEach(v => {
    const d = document.createElement("div");
    d.className = "visit-card";
    d.style.marginBottom = "8px";
    
    const dateStr = new Date(v.startAt).toLocaleDateString() + " " + new Date(v.startAt).toTimeString().slice(0,5);
    const shortSoap = v.soap ? v.soap.substring(0, 80) + (v.soap.length>80?"...":"") : "(è¨˜éŒ²ãªã—)";
    
    d.innerHTML = `
      <div style="font-size:11px; font-weight:bold; color:#555;">${dateStr} <span class="tag ${v.status==='completed'?'tag-gray':'tag-red'}">${v.status}</span></div>
      <div style="font-size:12px; white-space:pre-wrap; margin-top:4px;">${shortSoap}</div>
    `;
    histEl.appendChild(d);
  });
  
  // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
  clearRecordForm();
  document.getElementById("rec-date").valueAsDate = new Date();
  document.getElementById("rec-time-start").value = new Date().toTimeString().slice(0,5);
}

// Chart.jsã‚’ä½¿ã£ãŸãƒã‚¤ã‚¿ãƒ«ã‚°ãƒ©ãƒ•æç”»
function renderMiniChart(pid) {
  const ctx = document.getElementById("vitalsChartMini").getContext("2d");
  if(vitalsChart) vitalsChart.destroy();
  
  // å¯¾è±¡æ‚£è€…ã®ãƒã‚¤ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆæ—¥ä»˜é †ï¼‰
  const pVitals = appState.vitals
    .filter(v => v.patientId === pid)
    .sort((a,b) => new Date(a.measuredAt) - new Date(b.measuredAt));
  
  vitalsChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: pVitals.map(v => {
        const d = new Date(v.measuredAt);
        return `${d.getMonth()+1}/${d.getDate()}`;
      }),
      datasets: [
        { 
          label: 'åç¸®æœŸè¡€åœ§', 
          data: pVitals.map(v => v.bpSys), 
          borderColor: '#ef4444', 
          backgroundColor: 'rgba(239, 68, 68, 0.1)',
          tension: 0.1,
          fill: true
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: { 
        y: { beginAtZero: false, suggestedMin: 80, suggestedMax: 160 } 
      }
    }
  });
}

// ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¯ãƒªã‚¢
function clearRecordForm() {
  document.getElementById("rec-raw-input").value = "";
  document.getElementById("rec-soap").value = "";
  document.getElementById("rec-bp-sys").value = "";
  document.getElementById("rec-bp-dia").value = "";
  document.getElementById("rec-temp").value = "";
  document.getElementById("rec-spo2").value = "";
  document.getElementById("rec-visit-id").value = "";
}

/* --- AI & Save Actions --- */

// éŸ³å£°å…¥åŠ›ãƒ‡ãƒ¢ãƒœã‚¿ãƒ³
function startVoiceDemo() {
  const txt = document.getElementById("rec-raw-input");
  txt.value = "ï¼ˆéŸ³å£°èãå–ã‚Šä¸­...ï¼‰";
  setTimeout(() => {
    txt.value = "æœ¬æ—¥ã¯é¡”è‰²è‰¯å¥½ã€‚é£Ÿäº‹ã¯å…¨é‡æ‘‚å–ã§ããŸãŒã€å°‘ã—è¶³ã®ã‚€ãã¿ãŒã‚ã‚‹ã¨ã®ã“ã¨ã€‚ãƒã‚¤ã‚¿ãƒ«ã¯å®‰å®šã—ã¦ã„ã‚‹ãŒã€å¡©åˆ†æ‘‚å–ã«ã¤ã„ã¦æŒ‡å°ã‚’è¡Œã£ãŸã€‚å®¶æ—ã‹ã‚‰ã¯å¤œé–“ã®ãƒˆã‚¤ãƒ¬å›æ•°ãŒå¢—ãˆãŸã¨ã®ç›¸è«‡ã‚ã‚Šã€‚";
  }, 1500);
}

// AIç”Ÿæˆãƒ‡ãƒ¢
function generateAIReport() {
  const raw = document.getElementById("rec-raw-input").value;
  const soapArea = document.getElementById("rec-soap");
  
  if(!raw) return alert("ç”Ÿæˆå…ƒã¨ãªã‚‹ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

  soapArea.classList.add("typing");
  soapArea.value = "";
  
  // ãƒ‡ãƒ¢ç”¨ã®ç”Ÿæˆãƒ†ã‚­ã‚¹ãƒˆï¼ˆæœ¬æ¥ã¯APIã‹ã‚‰å–å¾—ï¼‰
  const soapText = `S: ã€Œè¶³ã®ã‚€ãã¿ãŒã‚ã‚‹ã€ã€Œå¤œé–“ã®ãƒˆã‚¤ãƒ¬å›æ•°ãŒå¢—ãˆãŸã€
O: é¡”è‰²è‰¯å¥½ã€é£Ÿäº‹å…¨é‡æ‘‚å–ã€‚ä¸‹è‚¢æµ®è…«(+)ã€BPå®‰å®šã€‚
A: å¿ƒä¸å…¨å¾´å€™ã®è‘—ã—ã„æ‚ªåŒ–ãªã—ã€‚å¤œé–“é »å°¿ã¯æµ®è…«ã«é–¢é€£ã™ã‚‹å¯èƒ½æ€§ã€‚
P: 
1. å¡©åˆ†åˆ¶é™ã®å†æŒ‡å°
2. ä¸‹è‚¢æŒ™ä¸Šã®åŠ±è¡Œ
3. æ¬¡å›è¨ªå•æ™‚ã€ä½“é‡å¤‰å‹•ã¨æµ®è…«ã®è©•ä¾¡`;

  let i = 0;
  function typeWriter() {
    if (i < soapText.length) {
      soapArea.value += soapText.charAt(i);
      i++;
      setTimeout(typeWriter, 15); // æ‰“éµã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    } else {
      soapArea.classList.remove("typing");
    }
  }
  typeWriter();
}

// ä¿å­˜å‡¦ç†ï¼ˆé›»å­ã‚«ãƒ«ãƒ†ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
function saveVisitRecord(e) {
  e.preventDefault();
  if(!currentPatientId) return alert("æ‚£è€…ã‚’é¸æŠã—ã¦ãã ã•ã„");

  const soap = document.getElementById("rec-soap").value;
  const dateVal = document.getElementById("rec-date").value;
  const timeVal = document.getElementById("rec-time-start").value;
  
  if(!dateVal || !timeVal) return alert("æ—¥æ™‚ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

  const startAtStr = dateVal + "T" + timeVal;
  
  // 1. Visitãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
  const newVisit = {
    id: genId(),
    patientId: currentPatientId,
    startAt: new Date(startAtStr).toISOString(),
    type: "regular",
    status: "completed",
    soap: soap
  };
  
  // æ—¢å­˜é…åˆ—ã«è¿½åŠ 
  appState.visits.push(newVisit);

  // 2. Vitalãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ (å€¤ãŒã‚ã‚‹å ´åˆã®ã¿)
  const sys = document.getElementById("rec-bp-sys").value;
  if(sys) {
    appState.vitals.push({
      patientId: currentPatientId,
      measuredAt: new Date(startAtStr).toISOString(),
      bpSys: sys,
      bpDia: document.getElementById("rec-bp-dia").value,
      temp: document.getElementById("rec-temp").value,
      spo2: document.getElementById("rec-spo2").value
    });
  }

  // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜
  saveState();
  
  alert("è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
  
  // ç”»é¢æ›´æ–°
  onRecordPatientChange(); 
  // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç­‰ã‚‚æ›´æ–°ã•ã‚Œã‚‹ã‚ˆã†ãƒªã‚»ãƒƒãƒˆ
  showView("record");
}

</script>
</body>
</html>