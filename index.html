<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>CareNexus AI : Integrated System</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<style>
/* ========== Base Design ========== */
:root { 
    --primary: #2563eb; 
    --primary-light: #eff6ff;
    --text-main: #111827; 
    --text-sub: #6b7280;
    --bg-body: #f3f4f6; 
    --bg-panel: #ffffff;
    --border: #e5e7eb;
    --danger: #ef4444; 
    --success: #10b981;
    --warning: #f59e0b;
}
body { margin: 0; background: var(--bg-body); color: var(--text-main); font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif; 
-webkit-font-smoothing: antialiased; padding-bottom: 80px; }
.app { max-width: 1200px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; position: relative; }

/* Components */
.btn { border: 1px solid var(--border); padding: 8px 14px; border-radius: 6px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; 
justify-content: center; gap: 6px; font-size: 13px; transition: 0.1s; background: white; color: var(--text-main); text-decoration: none; }
.btn:active { transform: translateY(1px); }
.btn-primary { background: var(--primary); color: white; border-color: var(--primary); }
.btn-danger { background: var(--danger); color: white; border-color: var(--danger); }
.btn-success { background: var(--success); color: white; border-color: var(--success); }
.btn-sm { font-size: 11px; padding: 4px 10px; height: 28px; }
.btn-xs { font-size: 10px; padding: 2px 8px; height: 24px; border-radius: 4px; }
.btn-ghost { background: transparent; border: none; color: var(--text-sub); }
.btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }

input, textarea, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: #f9fafb; font-size: 14px; box-sizing: border-box; 
transition:0.2s; margin-bottom: 4px; }
input:focus, textarea:focus, select:focus { outline: none; border-color: var(--primary); background: white; }
label { font-size: 11px; font-weight: bold; color: var(--text-sub); display: block; margin-bottom: 2px; }

.panel { background: var(--bg-panel); border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid var(--border); margin-bottom: 16px; }
.panel-title { font-size: 15px; font-weight: 700; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f3f4f6; padding-bottom: 10px; 
color: var(--text-main); }

/* Layouts */
.flex-row { display: flex; align-items: center; gap: 8px; }
.flex-between { display: flex; justify-content: space-between; align-items: center; }
.grid-2 { display: grid; grid-template-columns: 1fr; gap: 16px; }
@media(min-width: 900px) { .grid-2 { grid-template-columns: 1fr 1fr; } }

/* Login */
#loginScreen { position: fixed; inset: 0; background: var(--primary); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #fff; }
.pin-input { display: flex; gap: 10px; margin: 20px 0; }
.pin-dot { width: 16px; height: 16px; border-radius: 50%; border: 2px solid #fff; background: transparent; transition:0.2s; }
.pin-dot.filled { background: #fff; }
.numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
.num-btn { width: 60px; height: 60px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: #fff; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; cursor: pointer; transition:0.1s; }

/* Header & Tabs */
header { position: sticky; top: 0; z-index: 100; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); padding: 12px 16px; }
.logo { font-size: 18px; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 8px; }
.tabs { display: flex; gap: 6px; padding: 6px; background: #e5e7eb; border-radius: 10px; margin: 16px; overflow-x: auto; scrollbar-width: none; }
.tab { flex: 1; text-align: center; padding: 8px 12px; font-size: 13px; font-weight: 600; color: var(--text-sub); border-radius: 8px; cursor: pointer; white-space: nowrap; transition:0.2s; }
.tab.active { background: white; color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
.section { display: none; animation: fadeIn 0.3s ease; }
.section.active { display: block; padding: 0 16px; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* KBS / Omaha */
.kbs-input-group { background:#f0f9ff; padding:12px; border-radius:8px; border:1px solid #bae6fd; margin-bottom:12px; }
.kbs-input-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
.kbs-input-col label { color: #1e40af; margin-bottom: 4px; }
.kbs-input-col select { border-color: #bfdbfe; color: #1e40af; font-weight: bold; }

/* Workload Cards */
.load-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; }
.load-card { background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); position: relative; }
.load-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #eee; }
.load-name { font-weight: bold; font-size: 15px; }
.load-score-badge { font-size: 12px; font-weight: bold; padding: 4px 8px; border-radius: 12px; }
.score-danger { background: #fee2e2; color: #b91c1c; }
.score-warning { background: #fef3c7; color: #b45309; }
.score-success { background: #dcfce7; color: #15803d; }
.load-stat-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 6px; color: #4b5563; }
.load-val { font-weight: bold; color: var(--text-main); }
.load-bar-container { height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin-top: 12px; }
.load-bar-fill { height: 100%; border-radius: 4px; }

/* Matching */
.match-card { display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 8px; transition: 0.2s; background: #fff; }
.match-card:hover { border-color: var(--primary); background: #f0f9ff; }
.match-rank { font-size: 18px; font-weight: bold; color: #ccc; width: 20px; text-align: center; }
.match-card:first-child .match-rank { color: #f59e0b; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
.match-info { flex: 1; }
.match-score { font-weight: bold; font-size: 14px; color: var(--primary); }
.match-tags { display: flex; gap: 4px; margin-top: 4px; }
.match-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #f3f4f6; color: #555; }

/* Family Report Modal */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: none; align-items: center; justify-content: center; }
.modal-box { background: #fff; width: 90%; max-width: 500px; border-radius: 12px; padding: 20px; max-height: 80vh; overflow-y: auto; }
.report-paper { background: #fffaf0; border: 2px solid #fde68a; padding: 20px; border-radius: 8px; font-family: "Hiragino Mincho ProN", serif; line-height: 1.8; color: #4b3621; }

/* Micro View Table */
.micro-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.micro-table th { background: #f9fafb; padding: 8px; text-align: left; border-bottom: 1px solid #ddd; font-weight: bold; color: #555; }
.micro-table td { padding: 10px 8px; border-bottom: 1px solid #eee; }
.score-cell { font-weight: bold; color: var(--primary); }

/* Other utils */
.tag { display: inline-block; font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; background: #eee; margin-right: 4px; }
.timeline-container { position: relative; padding-left: 20px; border-left: 3px solid #e5e7eb; margin-left: 8px; margin-top: 10px; }
.timeline-item { position: relative; margin-bottom: 24px; }
.timeline-dot { position: absolute; left: -27px; top: 0; width: 12px; height: 12px; border-radius: 50%; background: var(--primary); border: 2px solid white; box-shadow: 0 0 0 2px #e5e7eb; }
.timeline-time { font-size: 13px; color: var(--text-main); font-weight: bold; margin-bottom: 6px; }
.timeline-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px 16px; font-size: 14px; display: flex; flex-direction: column; gap: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
.timeline-card.active { background: #eff6ff; border-color: var(--primary); border-left: 4px solid var(--primary); }
</style>
</head>
<body>

<div id="loginScreen">
    <div style="margin-bottom: 20px; text-align: center;">
        <i class="fa-solid fa-user-nurse" style="font-size: 3rem; margin-bottom: 10px;"></i>
        <h2>CareNexus AI</h2>
        <p style="opacity: 0.8;">Omaha Integrated Analytics</p>
    </div>
    <div class="pin-input">
        <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
    </div>
    <div class="numpad">
        <div class="num-btn" onclick="enterPin(1)">1</div><div class="num-btn" onclick="enterPin(2)">2</div><div class="num-btn" onclick="enterPin(3)">3</div>
        <div class="num-btn" onclick="enterPin(4)">4</div><div class="num-btn" onclick="enterPin(5)">5</div><div class="num-btn" onclick="enterPin(6)">6</div>
        <div class="num-btn" onclick="enterPin(7)">7</div><div class="num-btn" onclick="enterPin(8)">8</div><div class="num-btn" onclick="enterPin(9)">9</div>
        <div class="num-btn" onclick="authFaceID()"><i class="fa-solid fa-face-smile"></i></div><div class="num-btn" onclick="enterPin(0)">0</div><div class="num-btn" onclick="deletePin()"><i class="fa-solid fa-delete-left"></i></div>
    </div>
    <div class="mt-4 text-xs" style="margin-top:20px; opacity:0.7;">PIN: 0000</div>
</div>

<div id="familyReportModal" class="modal-overlay">
    <div class="modal-box">
        <div class="flex-between" style="margin-bottom:16px;">
            <h3 style="margin:0;">家族向けレポート (プレビュー)</h3>
            <button class="btn btn-sm btn-ghost" onclick="closeFamilyReport()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="report-paper" id="familyReportContent">
            </div>
        <div style="margin-top:16px; display:flex; gap:10px;">
            <button class="btn btn-primary" style="flex:1;"><i class="fa-brands fa-line"></i> LINEで送る</button>
            <button class="btn btn-outline" style="flex:1;"><i class="fa-solid fa-print"></i> 印刷</button>
        </div>
    </div>
</div>

<div class="app">
    <header class="flex-between">
        <div class="logo"><i class="fa-solid fa-heart-pulse"></i> CareNexus AI</div>
        <div class="flex-row">
            <button class="btn btn-sm btn-ghost"><i class="fa-regular fa-clock"></i> 11:15</button>
            <button class="btn btn-sm" onclick="toggleAdminMode()" id="adminBtn"><i class="fa-solid fa-user-gear"></i> 管理者</button>
        </div>
    </header>

    <div class="tabs">
        <div class="tab active" onclick="setTab('home')">ホーム</div>
        <div class="tab" onclick="setTab('calendar')">月次予定</div>
        <div class="tab" onclick="setTab('record')">記録・AI</div>
        <div class="tab" onclick="setTab('collab')">連携</div>
        <div class="tab" onclick="setTab('newuser')">新規登録</div>
        <div class="tab" onclick="setTab('admin')" id="adminTab" style="display:none;">管理・分析</div>
    </div>

    <section id="sect-home" class="section active">
        <div class="flex-row" style="margin-bottom:16px; background:white; padding:12px; border-radius:12px; border:1px solid #e5e7eb; gap:16px;">
            <div style="flex:1; display:flex; gap:10px; align-items:center;">
                <i class="fa-solid fa-sun" style="color:#f59e0b; font-size:24px;"></i>
                <div><div style="font-size:11px; color:#666;">東京 八王子</div><div style="font-weight:bold; font-size:15px;">晴れ 12℃</div></div>
            </div>
            <div style="width:1px; height:30px; background:#eee;"></div>
            <div style="flex:1; display:flex; gap:10px; align-items:center;">
                <i class="fa-solid fa-car" style="color:#6b7280; font-size:24px;"></i>
                <div><div style="font-size:11px; color:#666;">交通情報 (R20)</div><div style="font-weight:bold; font-size:15px; color:#10b981;">平常通り</div></div>
            </div>
        </div>

        <div class="grid-2">
            <div>
                <div class="panel">
                    <div class="panel-title">本日の訪問予定 (3件)</div>
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        <div class="flex-between" style="padding:8px; border-bottom:1px solid #eee;">
                            <div><div style="font-weight:bold; font-size:13px;">田中 太郎 様</div><div style="font-size:11px; color:#666;">09:00 - 定期巡回</div></div>
                            <div class="flex-row">
                                <span class="tag" style="background:#dcfce7; color:#15803d;">完了</span>
                                <button class="btn btn-sm btn-primary" onclick="goToPatient(1)">記録</button>
                            </div>
                        </div>
                        <div class="flex-between" style="padding:8px; border-bottom:1px solid #eee;">
                            <div><div style="font-weight:bold; font-size:13px;">佐藤 花子 様</div><div style="font-size:11px; color:#666;">11:00 - 入浴介助</div></div>
                            <div class="flex-row">
                                <span class="tag" style="background:#dbeafe; color:#1e40af;">進行中</span>
                                <button class="btn btn-sm btn-primary" onclick="goToPatient(2)">記録</button>
                            </div>
                        </div>
                        <div class="flex-between" style="padding:8px;">
                            <div><div style="font-weight:bold; font-size:13px;">鈴木 一郎 様</div><div style="font-size:11px; color:#666;">13:30 - リハビリ</div></div>
                            <div class="flex-row">
                                <span class="tag">予定</span>
                                <button class="btn btn-sm btn-primary" onclick="goToPatient(3)">記録</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex-col">
                <div class="panel">
                    <div class="panel-title">通知・アラート</div>
                    <div style="background:#fee2e2; border:1px solid #fecaca; color:#b91c1c; padding:12px; border-radius:6px; font-size:13px; margin-bottom:8px; display:flex; align-items:center; gap:8px;">
                        <i class="fa-solid fa-bell fa-shake"></i>
                        <div><b>急な訪問変更</b><br>鈴木様：13:30 -> 14:00に変更</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="sect-calendar" class="section">
        <div class="panel"><div class="panel-title">月次カレンダー</div><div style="text-align:center; padding:20px; color:#999;">カレンダー表示エリア</div></div>
    </section>

    <section id="sect-record" class="section">
        <div class="panel" style="background:#eef2ff; border-color:#dbeafe; padding:10px 16px;">
            <div class="flex-between">
                <div class="flex-row">
                    <i class="fa-solid fa-user-tag" style="color:var(--primary);"></i>
                    <span style="font-weight:bold; font-size:14px; white-space:nowrap;">利用者:</span>
                    <select id="patientSelector" style="min-width:180px;" onchange="switchPatient()">
                        <option value="1">田中 太郎 様</option>
                        <option value="2" selected>佐藤 花子 様</option>
                        <option value="3">鈴木 一郎 様</option>
                    </select>
                </div>
                <button class="btn btn-sm btn-outline" onclick="openFamilyReport()"><i class="fa-solid fa-users"></i> 家族向けレポート</button>
            </div>
        </div>

        <div class="panel">
            <div class="panel-title">
                <span>バイタル・成果評価</span>
                <div class="flex-row">
                    <button class="btn btn-xs btn-primary" onclick="toggleChartMode('vital')">バイタル</button>
                    <button class="btn btn-xs btn-outline" onclick="toggleChartMode('omaha')">状態推移</button>
                </div>
            </div>
            <div style="height:200px; position:relative;">
                <canvas id="vitalChart"></canvas>
                <canvas id="omahaChart" style="display:none;"></canvas>
            </div>
        </div>

        <div class="grid-2">
            <div class="panel">
                <div class="panel-title">訪問看護記録 (SOAP)</div>
                
                <div class="kbs-input-group">
                    <div style="font-size:12px; font-weight:bold; color:var(--primary); margin-bottom:8px;">
                        <i class="fa-solid fa-chart-line"></i> 本日のオマハシステム評価
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1.5fr; gap:8px; margin-bottom:12px;">
                        <div>
                            <label>領域 (Domain)</label>
                            <select id="omahaDomainSelect" onchange="updateOmahaProblems()"></select>
                        </div>
                        <div>
                            <label>問題 (Problem)</label>
                            <select id="omahaProblemSelect" onchange="loadPrevKBS()"></select>
                        </div>
                    </div>
                    <div class="kbs-input-row">
                        <div class="kbs-input-col"><label>知識 (K)</label><select id="input_k"><option value="3">3:基本的</option></select></div>
                        <div class="kbs-input-col"><label>行動 (B)</label><select id="input_b"><option value="3">3:時々</option></select></div>
                        <div class="kbs-input-col"><label>状態 (S)</label><select id="input_s"><option value="3">3:中等度</option></select></div>
                    </div>
                </div>

                <textarea id="aiInputMemo" rows="3" placeholder="AI用メモ: 「褥瘡は良化傾向。ガーゼ交換実施。」..."></textarea>
                <div class="flex-row" style="margin-bottom:10px;">
                    <button class="btn btn-primary" onclick="runAIGeneration()" id="btnGen"><i class="fa-solid fa-wand-magic-sparkles"></i> AI生成</button>
                    <button class="btn btn-ghost" onclick="alert('音声入力待機中...')"><i class="fa-solid fa-microphone"></i> 音声</button>
                </div>
                
                <div style="background:#f8fafb; padding:8px; border:1px solid #e5e7eb; border-radius:6px; margin-top:8px;">
                    <div style="font-size:11px; font-weight:bold; color:var(--primary);">【SOAP】</div>
                    <div id="soapArea" style="font-size:12px; white-space:pre-wrap; min-height:60px;"></div>
                </div>
                <button class="btn btn-success" style="width:100%; margin-top:10px;" onclick="saveRecord()">記録保存</button>
            </div>

            <div class="panel">
                <div class="panel-title">AIサマリー / 過去履歴</div>
                <div class="summary-box" id="aiSummaryText" style="background:#f0f9ff; padding:10px; border-radius:6px; font-size:13px; margin-bottom:10px;">
                    読み込み中...
                </div>
                <div id="historyList" style="max-height:300px; overflow-y:auto;">
                    </div>
            </div>
        </div>
    </section>

    <section id="sect-collab" class="section"><div class="panel">連携チャットルーム</div></section>
    <section id="sect-newuser" class="section"><div class="panel">新規登録フォーム</div></section>

    <section id="sect-admin" class="section">
        <div class="panel">
            <div class="panel-title">スタッフ動態管理マップ</div>
            <div style="height:300px; width:100%; border-radius:8px;" id="adminMap"></div>
        </div>

        <div class="panel">
            <div class="panel-title">労働負荷モニタリング (週間分析)</div>
            <div class="load-grid" id="adminWorkloadGrid">
                </div>
        </div>

        <div class="panel">
            <div class="panel-title">
                <span>AIスタッフマッチング (Dispatch)</span>
                <select id="matchPatientSelect" style="width:auto; font-size:12px; padding:4px;" onchange="updateMatching()">
                    <option value="">次回訪問先を選択...</option>
                    <option value="1">田中 太郎 (褥瘡処置)</option>
                    <option value="2">佐藤 花子 (入浴介助)</option>
                    <option value="3">鈴木 一郎 (リハビリ)</option>
                </select>
            </div>
            <div id="matchingResultArea">
                <div style="text-align:center; padding:20px; color:#999;">
                    <i class="fa-solid fa-people-arrows" style="font-size:32px; margin-bottom:10px;"></i><br>
                    訪問先を選択すると、AIが最適なスタッフを提案します。
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-title">利用者別 アウトカム評価一覧 (Micro View - Admin)</div>
            <div style="overflow-x:auto;">
                <table class="micro-table">
                    <thead>
                        <tr>
                            <th>最終訪問日</th> <th>利用者</th>
                            <th>問題分類</th>
                            <th>今回スコア (K/B/S)</th>
                            <th>評価</th>
                        </tr>
                    </thead>
                    <tbody id="microOutcomeBody">
                        </tbody>
                </table>
            </div>
        </div>
    </section>
</div>

<script>
// --- Data Definitions ---
const omahaMaster = {
    "環境": ["収入", "衛生状態", "住居", "安全"],
    "心理社会": ["コミュニケーション", "社会的接触", "精神的健康", "介護", "虐待"],
    "生理": ["聴覚", "視覚", "口腔", "認知", "痛み", "意識", "皮膚", "神経/筋肉/骨格", "呼吸", "循環", "消化", "排泄"],
    "健康関連": ["栄養", "睡眠", "身体活動", "ADL", "服薬管理"]
};

const staffData = [
    { id: "s1", name: "Ns.山田", role: "Ns", load: 92, hours: 45, visits: 28, dist: 120, status: "danger", skills: ["褥瘡", "緩和", "認知症"] },
    { id: "s2", name: "Ns.高橋", role: "Ns", load: 65, hours: 32, visits: 18, dist: 80, status: "success", skills: ["精神", "小児"] },
    { id: "s3", name: "PT.鈴木", role: "PT", load: 78, hours: 38, visits: 22, dist: 95, status: "warning", skills: ["リハビリ", "呼吸療法"] }
];

const patientDatabase = {
    1: { 
        name: "田中 太郎",
        omahaTag: "生理/皮膚",
        summary: "褥瘡（仙骨部）は肉芽形成期。発赤残存。ADL自立度低下。",
        history: [
            { date: "12/15", staff: "Ns.山田", content: "褥瘡処置実施。肉芽良好。" },
            { date: "12/13", staff: "Ns.高橋", content: "入浴介助。" }
        ],
        omahaScores: { k: [2,2,3], b: [3,3,4], s: [2,2,3] } 
    },
    2: { 
        name: "佐藤 花子",
        omahaTag: "生理/神経",
        summary: "パーキンソン病。すくみ足あり。服薬管理は自立。",
        history: [
            { date: "12/16", staff: "Ns.高橋", content: "状態観察。バイタル安定。" },
            { date: "12/14", staff: "PT.鈴木", content: "歩行訓練実施。" }
        ],
        omahaScores: { k: [3,3], b: [3,3], s: [3,3] }
    },
    3: { 
        name: "鈴木 一郎",
        omahaTag: "生理/筋肉骨格",
        summary: "左片麻痺。リハビリ意欲高い。妻の介護負担増。",
        history: [
            { date: "12/15", staff: "PT.鈴木", content: "可動域訓練。" },
            { date: "12/12", staff: "Ns.山田", content: "定期訪問。" }
        ],
        omahaScores: { k: [4,5], b: [4,5], s: [3,4] }
    }
};

// --- Core Logic ---

// Login
let pinBuffer = "";
function enterPin(n) { pinBuffer+=n; document.querySelectorAll('.pin-dot')[pinBuffer.length-1]?.classList.add('filled'); if(pinBuffer==="0000") loginSuccess(); }
function deletePin() { if(pinBuffer.length>0) { document.querySelectorAll('.pin-dot')[pinBuffer.length-1].classList.remove('filled'); pinBuffer=pinBuffer.slice(0,-1); } }
function authFaceID() { loginSuccess(); }
function loginSuccess() { document.getElementById('loginScreen').style.display='none'; }

// Tabs
function setTab(id) {
    document.querySelectorAll('.section').forEach(e=>e.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
    document.getElementById('sect-'+id).classList.add('active');
    
    // Tab specific inits
    if(id==='record') { initChart(); switchPatient(); }
    if(id==='admin') { initAdminMap(); renderWorkload(); renderMatching(); renderMicroOutcomes(); }
}

function goToPatient(id) { document.getElementById('patientSelector').value = id; setTab('record'); }

// --- Record Section Logic ---
function initOmahaSelector() {
    const d = document.getElementById('omahaDomainSelect');
    d.innerHTML = "";
    Object.keys(omahaMaster).forEach(k => d.innerHTML += `<option value="${k}">${k}</option>`);
    updateOmahaProblems();
}
function updateOmahaProblems() {
    const d = document.getElementById('omahaDomainSelect').value;
    const p = document.getElementById('omahaProblemSelect');
    p.innerHTML = "";
    omahaMaster[d].forEach(v => p.innerHTML += `<option value="${v}">${v}</option>`);
}
function loadPrevKBS() { /* Mock load */ }

function switchPatient() {
    const id = document.getElementById('patientSelector').value;
    const p = patientDatabase[id];
    document.getElementById('aiSummaryText').innerText = p.summary;
    document.getElementById('historyList').innerHTML = p.history.map(h => 
        `<div style="padding:8px; border-bottom:1px solid #eee;">
            <div style="font-size:11px; color:#666;">${h.date} - ${h.staff}</div>
            <div style="font-size:13px;">${h.content}</div>
         </div>`
    ).join('');
    // Mock Auto-Select Omaha based on Tag
    const tagParts = p.omahaTag.split('/');
    if(omahaMaster[tagParts[0]]) {
        document.getElementById('omahaDomainSelect').value = tagParts[0];
        updateOmahaProblems();
    }
}

function runAIGeneration() {
    const btn = document.getElementById('btnGen');
    btn.innerHTML = "生成中...";
    setTimeout(() => {
        btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> AI生成';
        document.getElementById('soapArea').innerText = "[S] 痛み軽減\n[O] 創部:肉芽盛り上がり良好\n[A] 治癒傾向\n[P] 次回よりドレッシング変更検討";
    }, 1000);
}

function saveRecord() { alert("保存しました"); }

// --- Chart Logic (Simplified) ---
function initChart() {
    if(window.myChart) return;
    const ctx = document.getElementById('vitalChart').getContext('2d');
    window.myChart = new Chart(ctx, {
        type: 'line',
        data: { labels: ['12/12','12/13','12/14','12/15','Today'], datasets: [{label:'血圧(上)', data:[130,128,135,132,130], borderColor:'red'}] },
        options: { maintainAspectRatio: false }
    });
}
function toggleChartMode(m) {
    document.getElementById('vitalChart').style.display = m==='vital'?'block':'none';
    document.getElementById('omahaChart').style.display = m==='omaha'?'block':'none';
}

// --- Family Report Logic (New) ---
function openFamilyReport() {
    const id = document.getElementById('patientSelector').value;
    const p = patientDatabase[id];
    const modal = document.getElementById('familyReportModal');
    const content = document.getElementById('familyReportContent');
    
    // Simple mock logic to make report friendly
    let friendlySummary = p.summary
        .replace("褥瘡", "床ずれ")
        .replace("仙骨部", "お尻のあたり")
        .replace("肉芽形成期", "新しい皮膚ができ始めています")
        .replace("ADL", "生活動作")
        .replace("左片麻痺", "左側の動かしにくさ")
        .replace("バイタル", "血圧や体温");

    content.innerHTML = `
        <h4 style="text-align:center; border-bottom:1px solid #ddd; padding-bottom:10px;">訪問看護ご報告</h4>
        <p><strong>${p.name} 様</strong>のご家族様へ</p>
        <p>いつも大変お世話になっております。本日の訪問のご様子をお伝えします。</p>
        <div style="margin:16px 0;">
            <strong>【ご様子】</strong><br>
            ${friendlySummary}
        </div>
        <p>本日はお顔色もよく、リラックスされていました。次回は${p.history[0]?.date}頃を予定しております。<br>
        何かご心配な点がございましたら、いつでもステーションまでご連絡ください。</p>
        <p style="text-align:right; margin-top:20px;">担当: CareNexus 訪問看護ステーション</p>
    `;
    modal.style.display = 'flex';
}
function closeFamilyReport() { document.getElementById('familyReportModal').style.display='none'; }

// --- Admin Logic ---

// 1. Workload (Fixed: Show 3 cards)
function renderWorkload() {
    const grid = document.getElementById('adminWorkloadGrid');
    grid.innerHTML = "";
    staffData.forEach(s => {
        let badgeClass = s.status === 'danger' ? 'score-danger' : (s.status === 'warning' ? 'score-warning' : 'score-success');
        let barColor = s.status === 'danger' ? 'var(--danger)' : (s.status === 'warning' ? 'var(--warning)' : 'var(--success)');
        let label = s.status === 'danger' ? '危険' : (s.status === 'warning' ? '注意' : '適正');
        
        grid.innerHTML += `
        <div class="load-card">
            <div class="load-header">
                <span class="load-name"><i class="fa-solid fa-user-nurse"></i> ${s.name}</span>
                <span class="load-score-badge ${badgeClass}">${label} (${s.load})</span>
            </div>
            <div class="load-stat-row"><span>労働時間</span><span class="load-val">${s.hours}h</span></div>
            <div class="load-stat-row"><span>訪問件数</span><span class="load-val">${s.visits}件</span></div>
            <div class="load-stat-row"><span>移動距離</span><span class="load-val">${s.dist}km</span></div>
            <div class="load-bar-container">
                <div class="load-bar-fill" style="width:${s.load}%; background:${barColor};"></div>
            </div>
        </div>`;
    });
}

// 2. Matching (Fixed: Interactive Field Tool)
function updateMatching() {
    const pid = document.getElementById('matchPatientSelect').value;
    const area = document.getElementById('matchingResultArea');
    if(!pid) {
        area.innerHTML = `<div style="text-align:center; padding:20px; color:#999;">訪問先を選択すると、AIが最適なスタッフを提案します。</div>`;
        return;
    }

    // Simple Scoring Logic
    // If patient needs Rehab (ID 3), PT gets bonus.
    // If patient needs Skin care (ID 1), Ns with "褥瘡" skill gets bonus.
    let scoredStaff = staffData.map(s => {
        let score = 70; // Base
        if(pid === '3' && s.role === 'PT') score += 25; // Rehab needs PT
        if(pid === '1' && s.skills.includes('褥瘡')) score += 20;
        if(s.status === 'danger') score -= 30; // Overworked penalty
        return { ...s, matchScore: score };
    }).sort((a,b) => b.matchScore - a.matchScore);

    let html = "";
    scoredStaff.forEach((s, idx) => {
        html += `
        <div class="match-card">
            <div class="match-rank">${idx+1}</div>
            <div style="width:40px; height:40px; background:#eee; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; color:#555;">
                ${s.role}
            </div>
            <div class="match-info">
                <div class="flex-between">
                    <span style="font-weight:bold;">${s.name}</span>
                    <span class="match-score">マッチ度 ${s.matchScore}%</span>
                </div>
                <div class="match-tags">
                    ${s.skills.map(sk => `<span class="match-tag">${sk}</span>`).join('')}
                    ${s.status==='danger' ? '<span class="match-tag" style="background:#fee2e2; color:#b91c1c;">過負荷</span>' : ''}
                </div>
            </div>
            <button class="btn btn-sm btn-primary">アサイン</button>
        </div>`;
    });
    area.innerHTML = html;
}

// 3. Micro View (Fixed: Add Date)
function renderMicroOutcomes() {
    const tbody = document.getElementById('microOutcomeBody');
    tbody.innerHTML = "";
    Object.keys(patientDatabase).forEach(k => {
        const p = patientDatabase[k];
        const lastDate = p.history[0] ? p.history[0].date : "-";
        const k_val = p.omahaScores.k.slice(-1)[0];
        const b_val = p.omahaScores.b.slice(-1)[0];
        const s_val = p.omahaScores.s.slice(-1)[0];
        
        tbody.innerHTML += `
            <tr>
                <td style="font-size:12px; color:#666;">${lastDate}</td>
                <td style="font-weight:bold;">${p.name}</td>
                <td><span class="tag">${p.omahaTag}</span></td>
                <td class="score-cell">${k_val} / ${b_val} / ${s_val}</td>
                <td>${s_val >= 4 ? '<span style="color:green">良好</span>' : '観察'}</td>
            </tr>
        `;
    });
}

function initAdminMap() {
    if(document.getElementById('adminMap').innerHTML !== "") return;
    const map = L.map('adminMap').setView([35.6581, 139.3303], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
    // Mock Pins
    L.marker([35.6581, 139.3303]).addTo(map).bindPopup("Ns.山田");
    L.marker([35.6600, 139.3400]).addTo(map).bindPopup("PT.鈴木");
    L.marker([35.6550, 139.3250]).addTo(map).bindPopup("Ns.高橋");
}

function toggleAdminMode() {
    const p = prompt("管理者パスワード (admin)");
    if(p==="admin") { document.getElementById('adminTab').style.display='block'; setTab('admin'); }
}

// Init
window.onload = function() {
    initOmahaSelector();
};
</script>
</body>
</html>
