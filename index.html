<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>訪問看護ステーション向け 電子カルテ デモ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- シンプルなリセットCSS -->
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: #f5f5f7; color: #222; }
    body { min-height: 100vh; }

    header {
      background: #1976d2;
      color: #fff;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      font-size: 18px;
      margin: 0;
    }
    header .user-info {
      font-size: 13px;
    }
    header button {
      background: rgba(255,255,255,0.15);
      border: none;
      color: #fff;
      padding: 6px 10px;
      margin-left: 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    header button:hover {
      background: rgba(255,255,255,0.25);
    }

    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    .view {
      display: none;
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(15,23,42,0.1);
      margin-bottom: 24px;
    }

    .view.active {
      display: block;
    }

    h2 {
      font-size: 18px;
      margin: 0 0 12px;
    }
    h3 {
      font-size: 16px;
      margin: 16px 0 8px;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 12px;
    }
    .form-field {
      flex: 1 1 200px;
      display: flex;
      flex-direction: column;
      font-size: 13px;
    }
    .form-field label {
      margin-bottom: 4px;
      font-weight: 600;
    }
    .form-field input,
    .form-field select,
    .form-field textarea {
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 13px;
    }
    .form-field textarea {
      min-height: 80px;
      resize: vertical;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 12px;
      font-size: 13px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background: #1976d2;
      color: #fff;
    }
    .btn.secondary {
      background: #e0e0e0;
      color: #111;
    }
    .btn.danger {
      background: #d32f2f;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .btn + .btn {
      margin-left: 8px;
    }

    .table-wrapper {
      overflow-x: auto;
      margin-top: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      border-bottom: 1px solid #e0e0e0;
      padding: 6px 8px;
      text-align: left;
      white-space: nowrap;
    }
    th {
      background: #f3f4f6;
    }
    tr:hover {
      background: #f9fafb;
    }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      font-size: 11px;
      border-radius: 999px;
      background: #e3f2fd;
      color: #1565c0;
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid #e0e0e0;
      margin-bottom: 8px;
    }
    .tab {
      padding: 6px 12px;
      cursor: pointer;
      font-size: 13px;
      border-bottom: 2px solid transparent;
    }
    .tab.active {
      border-bottom-color: #1976d2;
      font-weight: 600;
      color: #1976d2;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #e0f7fa;
      margin: 2px;
    }

    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 8px;
      margin-top: 8px;
    }
    .photo-card {
      border-radius: 6px;
      border: 1px solid #e0e0e0;
      padding: 4px;
      background: #fafafa;
    }
    .photo-card img {
      display: block;
      width: 100%;
      height: 80px;
      object-fit: cover;
      border-radius: 4px;
      margin-bottom: 4px;
    }
    .photo-card div {
      font-size: 11px;
    }

    .tag-input {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }
    .tag-input input {
      flex: 1 1 80px;
      min-width: 80px;
    }

    .small-text {
      font-size: 11px;
      color: #666;
    }

    .error-text {
      color: #d32f2f;
      font-size: 12px;
      margin-top: 4px;
    }

    @media (max-width: 768px) {
      main { padding: 8px; }
      header { flex-direction: column; align-items: flex-start; gap: 4px; }
      .table-wrapper { font-size: 12px; }
      th, td { padding: 4px 6px; }
    }
  </style>

  <!-- Chart.js for vitals chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
<header>
  <h1>訪問看護 電子カルテ デモ</h1>
  <div class="user-info" id="user-info">
    未ログイン
    <button id="logout-btn" style="display:none;">ログアウト</button>
  </div>
</header>

<main>
  <!-- ログイン画面 -->
  <section class="view active" id="view-login">
    <h2>ログイン</h2>
    <p class="small-text">
      デモアカウント：email <code>nurse@example.com</code> / password <code>demo1234</code>
    </p>
    <form id="login-form">
      <div class="form-row">
        <div class="form-field">
          <label for="login-email">メールアドレス</label>
          <input type="email" id="login-email" required />
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
          <label for="login-password">パスワード</label>
          <input type="password" id="login-password" required />
        </div>
      </div>
      <button type="submit" class="btn">ログイン</button>
      <div id="login-error" class="error-text" style="display:none;"></div>
    </form>
  </section>

  <!-- ダッシュボード -->
  <section class="view" id="view-dashboard">
    <h2>ダッシュボード</h2>
    <div class="form-row">
      <button class="btn secondary" id="nav-to-patients">利用者一覧</button>
      <button class="btn secondary" id="nav-to-schedule">本日の訪問予定</button>
    </div>
    <h3>本日の訪問予定</h3>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th>時間</th>
          <th>利用者</th>
          <th>種別</th>
          <th>担当</th>
          <th>状態</th>
        </tr>
        </thead>
        <tbody id="dashboard-visits-body">
        </tbody>
      </table>
    </div>
  </section>

  <!-- 利用者一覧 -->
  <section class="view" id="view-patients">
    <h2>利用者一覧</h2>
    <div class="form-row">
      <div class="form-field">
        <label for="patient-search">検索（氏名）</label>
        <input id="patient-search" type="text" placeholder="例）山田" />
      </div>
      <div class="form-field" style="align-self:flex-end;">
        <button class="btn" id="btn-new-patient">新規利用者登録</button>
      </div>
    </div>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th>氏名</th>
          <th>生年月日</th>
          <th>性別</th>
          <th>電話</th>
        </tr>
        </thead>
        <tbody id="patients-table-body">
        </tbody>
      </table>
    </div>

    <h3 id="patient-form-title">新規利用者登録</h3>
    <form id="patient-form">
      <input type="hidden" id="patient-id" />
      <div class="form-row">
        <div class="form-field">
          <label>姓</label>
          <input id="patient-last-name" required />
        </div>
        <div class="form-field">
          <label>名</label>
          <input id="patient-first-name" required />
        </div>
        <div class="form-field">
          <label>生年月日</label>
          <input type="date" id="patient-birth-date" />
        </div>
        <div class="form-field">
          <label>性別</label>
          <select id="patient-sex">
            <option value="">未選択</option>
            <option value="M">男性</option>
            <option value="F">女性</option>
            <option value="U">その他</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
          <label>電話番号</label>
          <input id="patient-phone" />
        </div>
        <div class="form-field">
          <label>住所</label>
          <input id="patient-address" />
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
          <label>メモ</label>
          <textarea id="patient-notes"></textarea>
        </div>
      </div>
      <button type="submit" class="btn" id="patient-save-btn">保存</button>
      <button type="button" class="btn secondary" id="patient-reset-btn">クリア</button>
    </form>
  </section>

  <!-- 利用者詳細 -->
  <section class="view" id="view-patient-detail">
    <h2 id="patient-detail-name">利用者詳細</h2>
    <p class="small-text" id="patient-detail-basic"></p>
    <div class="tabs">
      <div class="tab active" data-tab="detail-visits">訪問/記録</div>
      <div class="tab" data-tab="detail-vitals">バイタル</div>
      <div class="tab" data-tab="detail-photos">写真</div>
    </div>

    <div id="detail-visits" class="detail-tab active">
      <div class="form-row">
        <button class="btn" id="btn-new-visit">新規訪問予定</button>
      </div>
      <h3>訪問一覧</h3>
      <div class="table-wrapper">
        <table>
          <thead>
          <tr>
            <th>日時</th>
            <th>種別</th>
            <th>担当</th>
            <th>状態</th>
            <th>操作</th>
          </tr>
          </thead>
          <tbody id="patient-visits-body"></tbody>
        </table>
      </div>
      <h3>訪問予定作成</h3>
      <form id="visit-form">
        <input type="hidden" id="visit-id" />
        <div class="form-row">
          <div class="form-field">
            <label>日付</label>
            <input type="date" id="visit-date" required />
          </div>
          <div class="form-field">
            <label>開始時刻</label>
            <input type="time" id="visit-start-time" required />
          </div>
          <div class="form-field">
            <label>終了時刻</label>
            <input type="time" id="visit-end-time" />
          </div>
          <div class="form-field">
            <label>種別</label>
            <select id="visit-type">
              <option value="regular">定期</option>
              <option value="oncall">オンコール</option>
              <option value="emergency">緊急</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-field">
            <label>担当者</label>
            <input id="visit-nurse" placeholder="例）看護師A" />
          </div>
          <div class="form-field">
            <label>メモ</label>
            <input id="visit-memo" />
          </div>
        </div>
        <button type="submit" class="btn">訪問予定を保存</button>
        <button type="button" class="btn secondary" id="visit-reset-btn">クリア</button>
      </form>
    </div>

    <div id="detail-vitals" class="detail-tab" style="display:none;">
      <h3>バイタル推移</h3>
      <canvas id="vitals-chart" height="200"></canvas>
      <h3>バイタル記録追加</h3>
      <form id="vital-form">
        <div class="form-row">
          <div class="form-field">
            <label>測定日時</label>
            <input type="datetime-local" id="vital-datetime" required />
          </div>
          <div class="form-field">
            <label>体温 (℃)</label>
            <input type="number" step="0.1" id="vital-temp" />
          </div>
          <div class="form-field">
            <label>収縮期血圧</label>
            <input type="number" id="vital-bp-sys" />
          </div>
          <div class="form-field">
            <label>拡張期血圧</label>
            <input type="number" id="vital-bp-dia" />
          </div>
        </div>
        <div class="form-row">
          <div class="form-field">
            <label>脈拍 (bpm)</label>
            <input type="number" id="vital-pulse" />
          </div>
          <div class="form-field">
            <label>SpO₂ (%)</label>
            <input type="number" id="vital-spo2" />
          </div>
        </div>
        <button type="submit" class="btn">バイタルを追加</button>
      </form>
      <h3>最近のバイタル一覧</h3>
      <div class="table-wrapper">
        <table>
          <thead>
          <tr>
            <th>日時</th>
            <th>体温</th>
            <th>血圧</th>
            <th>脈拍</th>
            <th>SpO₂</th>
          </tr>
          </thead>
          <tbody id="vitals-table-body"></tbody>
        </table>
      </div>
    </div>

    <div id="detail-photos" class="detail-tab" style="display:none;">
      <h3>写真登録</h3>
      <form id="photo-form">
        <div class="form-row">
          <div class="form-field">
            <label>写真ファイル</label>
            <input type="file" id="photo-file" accept="image/*" />
          </div>
          <div class="form-field">
            <label>タグ（カンマ区切り）</label>
            <input id="photo-tags" placeholder="例）褥瘡,創部,薬" />
          </div>
          <div class="form-field">
            <label>コメント</label>
            <input id="photo-comment" />
          </div>
        </div>
        <button type="submit" class="btn">写真を保存</button>
      </form>
      <h3>写真一覧</h3>
      <div class="photo-grid" id="photo-grid"></div>
    </div>
  </section>

  <!-- 訪問記録入力（記録書IIイメージ） -->
  <section class="view" id="view-visit-note">
    <h2>訪問看護記録入力</h2>
    <p class="small-text" id="visit-note-header"></p>
    <form id="visit-note-form">
      <div class="form-row">
        <div class="form-field">
          <label>主観的情報（S）</label>
          <textarea id="note-subjective" placeholder="例）昨夜はよく眠れたとのこと。"></textarea>
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
          <label>客観的情報（O）</label>
          <textarea id="note-objective" placeholder="バイタル・創部観察など"></textarea>
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
          <label>評価（A）</label>
          <textarea id="note-assessment"></textarea>
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
          <label>計画（P）</label>
          <textarea id="note-plan"></textarea>
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
          <label>自由記載（音声入力想定）</label>
          <textarea id="note-free" placeholder="音声入力から貼り付け可"></textarea>
        </div>
      </div>
      <button type="submit" class="btn">記録を保存</button>
      <button type="button" class="btn secondary" id="btn-note-back">戻る</button>
    </form>
  </section>

  <!-- シンプルな本日訪問一覧（スケジュールビュー） -->
  <section class="view" id="view-schedule">
    <h2>本日の訪問スケジュール</h2>
    <p class="small-text" id="schedule-date-label"></p>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th>時間</th>
          <th>利用者</th>
          <th>種別</th>
          <th>担当</th>
          <th>状態</th>
          <th>操作</th>
        </tr>
        </thead>
        <tbody id="schedule-table-body"></tbody>
      </table>
    </div>
    <button class="btn secondary" id="btn-schedule-back">ダッシュボードに戻る</button>
  </section>
</main>

<script>
  "use strict";

  // --- データモデルとストレージ ---------------------------------------

  const STORAGE_KEY = "houkan_karte_demo_v1";

  function genId() {
    return "id-" + Math.random().toString(36).slice(2) + Date.now().toString(36);
  }

  function todayISODate() {
    return new Date().toISOString().slice(0, 10);
  }

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return createInitialState();
      const parsed = JSON.parse(raw);
      // 簡易マイグレーション
      if (!parsed.photos) parsed.photos = [];
      return parsed;
    } catch (e) {
      console.error("failed to load state", e);
      return createInitialState();
    }
  }

  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
  }

  function createInitialState() {
    const userId = genId();
    const patientId = genId();
    const visitId = genId();
    const now = new Date();
    const visitStart = new Date();
    visitStart.setHours(9, 0, 0, 0);
    const visitEnd = new Date();
    visitEnd.setHours(9, 40, 0, 0);

    return {
      users: [
        {
          id: userId,
          email: "nurse@example.com",
          passwordHash: null, // デモ用: プレーンで判定
          passwordPlain: "demo1234",
          name: "看護師A",
          roles: ["nurse"]
        }
      ],
      patients: [
        {
          id: patientId,
          lastName: "山田",
          firstName: "太郎",
          birthDate: "1940-01-01",
          sex: "M",
          phone: "090-0000-0000",
          address: "東京都サンプル区1-1-1",
          notes: "糖尿病・褥瘡あり。ご家族同居。"
        }
      ],
      visits: [
        {
          id: visitId,
          patientId,
          startAt: visitStart.toISOString(),
          endAt: visitEnd.toISOString(),
          type: "regular",
          nurse: "看護師A",
          status: "scheduled",
          memo: "創部処置・バイタルチェック"
        }
      ],
      visitNotes: [],
      vitals: [
        {
          id: genId(),
          patientId,
          visitId,
          measuredAt: new Date(now.getTime() - 86400000).toISOString(),
          temp: 36.7,
          bpSys: 128,
          bpDia: 78,
          pulse: 72,
          spo2: 97
        },
        {
          id: genId(),
          patientId,
          visitId,
          measuredAt: now.toISOString(),
          temp: 36.8,
          bpSys: 126,
          bpDia: 76,
          pulse: 70,
          spo2: 98
        }
      ],
      photos: []
    };
  }

  let appState = loadState();
  let currentUser = null;
  let currentPatientId = null;
  let currentVisitId = null;
  let vitalsChart = null;

  // --- ビュー切り替え --------------------------------------------------

  function showView(id) {
    document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
    document.getElementById(id).classList.add("active");
  }

  function updateHeader() {
    const userInfo = document.getElementById("user-info");
    const logoutBtn = document.getElementById("logout-btn");
    if (currentUser) {
      userInfo.innerHTML = `
        ログイン中: ${currentUser.name} <span class="small-text">(${currentUser.email})</span>
      `;
      logoutBtn.style.display = "inline-flex";
    } else {
      userInfo.textContent = "未ログイン";
      logoutBtn.style.display = "none";
    }
  }

  // --- ログイン --------------------------------------------------------

  function handleLogin(email, password) {
    const user = appState.users.find(u => u.email === email);
    if (!user) return null;
    if (user.passwordPlain && user.passwordPlain === password) {
      return user;
    }
    return null;
  }

  function initLogin() {
    const form = document.getElementById("login-form");
    const errorEl = document.getElementById("login-error");
    form.addEventListener("submit", e => {
      e.preventDefault();
      const email = document.getElementById("login-email").value.trim();
      const password = document.getElementById("login-password").value;
      const user = handleLogin(email, password);
      if (!user) {
        errorEl.style.display = "block";
        errorEl.textContent = "メールアドレスまたはパスワードが正しくありません。";
        return;
      }
      currentUser = user;
      errorEl.style.display = "none";
      updateHeader();
      renderDashboard();
      showView("view-dashboard");
    });
    document.getElementById("logout-btn").addEventListener("click", () => {
      currentUser = null;
      updateHeader();
      showView("view-login");
    });
  }

  // --- ダッシュボード / スケジュール -----------------------------------

  function formatDateTime(dtStr) {
    if (!dtStr) return "";
    const d = new Date(dtStr);
    const yyyy = d.getFullYear();
    const mm = ("0" + (d.getMonth() + 1)).slice(0 - 2);
    const dd = ("0" + d.getDate()).slice(0 - 2);
    const hh = ("0" + d.getHours()).slice(0 - 2);
    const mi = ("0" + d.getMinutes()).slice(0 - 2);
    return `${yyyy}/${mm}/${dd} ${hh}:${mi}`;
  }

  function formatTime(dtStr) {
    if (!dtStr) return "";
    const d = new Date(dtStr);
    const hh = ("0" + d.getHours()).slice(0 - 2);
    const mi = ("0" + d.getMinutes()).slice(0 - 2);
    return `${hh}:${mi}`;
  }

  function getPatientName(id) {
    const p = appState.patients.find(p => p.id === id);
    if (!p) return "";
    return p.lastName + " " + p.firstName;
  }

  function renderDashboard() {
    const tbody = document.getElementById("dashboard-visits-body");
    tbody.innerHTML = "";
    const today = todayISODate();
    const visits = appState.visits
      .filter(v => (v.startAt || "").slice(0, 10) === today)
      .sort((a, b) => (a.startAt > b.startAt ? 1 : -1));
    if (visits.length === 0) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 5;
      td.textContent = "本日の訪問予定はありません。";
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }
    visits.forEach(v => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${formatTime(v.startAt)}〜${formatTime(v.endAt)}</td>
        <td>${getPatientName(v.patientId)}</td>
        <td>${v.type === "regular" ? "定期" : v.type === "oncall" ? "オンコール" : "緊急"}</td>
        <td>${v.nurse || ""}</td>
        <td><span class="pill">${v.status}</span></td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderScheduleView() {
    const tbody = document.getElementById("schedule-table-body");
    const label = document.getElementById("schedule-date-label");
    const today = todayISODate();
    label.textContent = `対象日: ${today}`;
    tbody.innerHTML = "";
    const visits = appState.visits
      .filter(v => (v.startAt || "").slice(0, 10) === today)
      .sort((a, b) => (a.startAt > b.startAt ? 1 : -1));
    if (visits.length === 0) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 6;
      td.textContent = "本日の訪問予定はありません。";
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }
    visits.forEach(v => {
      const tr = document.createElement("tr");
      const hasNote = appState.visitNotes.some(n => n.visitId === v.id);
      tr.innerHTML = `
        <td>${formatTime(v.startAt)}〜${formatTime(v.endAt)}</td>
        <td>${getPatientName(v.patientId)}</td>
        <td>${v.type === "regular" ? "定期" : v.type === "oncall" ? "オンコール" : "緊急"}</td>
        <td>${v.nurse || ""}</td>
        <td><span class="pill">${v.status}</span></td>
        <td>
          <button class="btn secondary btn-small" data-action="open-note" data-visit-id="${v.id}" data-patient-id="${v.patientId}">
            ${hasNote ? "記録を編集" : "記録入力"}
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // --- 利用者一覧 ------------------------------------------------------

  function renderPatientsList() {
    const tbody = document.getElementById("patients-table-body");
    const q = document.getElementById("patient-search").value.trim();
    tbody.innerHTML = "";
    const items = appState.patients
      .filter(p => {
        if (!q) return true;
        const name = (p.lastName + p.firstName).toLowerCase();
        return name.includes(q.toLowerCase());
      })
      .sort((a, b) => ((a.lastName + a.firstName) > (b.lastName + b.firstName) ? 1 : -1));

    if (items.length === 0) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 4;
      td.textContent = "該当する利用者がいません。";
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    items.forEach(p => {
      const tr = document.createElement("tr");
      tr.dataset.patientId = p.id;
      tr.innerHTML = `
        <td>${p.lastName} ${p.firstName}</td>
        <td>${p.birthDate || ""}</td>
        <td>${p.sex === "M" ? "男性" : p.sex === "F" ? "女性" : ""}</td>
        <td>${p.phone || ""}</td>
      `;
      tr.addEventListener("click", () => {
        openPatientDetail(p.id);
      });
      tbody.appendChild(tr);
    });
  }

  function resetPatientForm() {
    document.getElementById("patient-id").value = "";
    document.getElementById("patient-last-name").value = "";
    document.getElementById("patient-first-name").value = "";
    document.getElementById("patient-birth-date").value = "";
    document.getElementById("patient-sex").value = "";
    document.getElementById("patient-phone").value = "";
    document.getElementById("patient-address").value = "";
    document.getElementById("patient-notes").value = "";
    document.getElementById("patient-form-title").textContent = "新規利用者登録";
    document.getElementById("patient-save-btn").textContent = "保存";
  }

  function fillPatientForm(p) {
    document.getElementById("patient-id").value = p.id;
    document.getElementById("patient-last-name").value = p.lastName || "";
    document.getElementById("patient-first-name").value = p.firstName || "";
    document.getElementById("patient-birth-date").value = p.birthDate || "";
    document.getElementById("patient-sex").value = p.sex || "";
    document.getElementById("patient-phone").value = p.phone || "";
    document.getElementById("patient-address").value = p.address || "";
    document.getElementById("patient-notes").value = p.notes || "";
    document.getElementById("patient-form-title").textContent = "利用者情報編集";
    document.getElementById("patient-save-btn").textContent = "更新";
  }

  function initPatients() {
    document.getElementById("patient-search").addEventListener("input", () => {
      renderPatientsList();
    });
    document.getElementById("btn-new-patient").addEventListener("click", () => {
      resetPatientForm();
    });
    document.getElementById("patient-reset-btn").addEventListener("click", () => {
      resetPatientForm();
    });

    document.getElementById("patient-form").addEventListener("submit", e => {
      e.preventDefault();
      const id = document.getElementById("patient-id").value || genId();
      const lastName = document.getElementById("patient-last-name").value.trim();
      const firstName = document.getElementById("patient-first-name").value.trim();
      if (!lastName || !firstName) {
        alert("姓・名は必須です。");
        return;
      }
      const birthDate = document.getElementById("patient-birth-date").value || null;
      const sex = document.getElementById("patient-sex").value || "";
      const phone = document.getElementById("patient-phone").value || "";
      const address = document.getElementById("patient-address").value || "";
      const notes = document.getElementById("patient-notes").value || "";

      const existing = appState.patients.find(p => p.id === id);
      if (existing) {
        existing.lastName = lastName;
        existing.firstName = firstName;
        existing.birthDate = birthDate;
        existing.sex = sex;
        existing.phone = phone;
        existing.address = address;
        existing.notes = notes;
      } else {
        appState.patients.push({ id, lastName, firstName, birthDate, sex, phone, address, notes });
      }
      saveState();
      renderPatientsList();
      resetPatientForm();
      alert("利用者情報を保存しました。");
    });
  }

  // --- 利用者詳細 / 訪問 / バイタル / 写真 -----------------------------

  function switchPatientDetailTab(tabId) {
    document.querySelectorAll("#view-patient-detail .tab").forEach(t => {
      t.classList.toggle("active", t.dataset.tab === tabId);
    });
    document.querySelectorAll("#view-patient-detail .detail-tab").forEach(d => {
      d.style.display = d.id === tabId ? "" : "none";
    });
  }

  function renderPatientDetailBasic() {
    const p = appState.patients.find(p => p.id === currentPatientId);
    if (!p) return;
    document.getElementById("patient-detail-name").textContent = `${p.lastName} ${p.firstName}`;
    document.getElementById("patient-detail-basic").textContent =
      `生年月日: ${p.birthDate || "-"} / 性別: ${p.sex === "M" ? "男性" : p.sex === "F" ? "女性" : "-"} / 電話: ${p.phone || "-"} / 住所: ${p.address || "-"}`;
  }

  function renderPatientVisits() {
    const tbody = document.getElementById("patient-visits-body");
    tbody.innerHTML = "";
    const visits = appState.visits
      .filter(v => v.patientId === currentPatientId)
      .sort((a, b) => (a.startAt > b.startAt ? -1 : 1));
    if (visits.length === 0) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 5;
      td.textContent = "訪問予定・実績はまだ登録されていません。";
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }
    visits.forEach(v => {
      const hasNote = appState.visitNotes.some(n => n.visitId === v.id);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${formatDateTime(v.startAt)}</td>
        <td>${v.type === "regular" ? "定期" : v.type === "oncall" ? "オンコール" : "緊急"}</td>
        <td>${v.nurse || ""}</td>
        <td><span class="pill">${v.status}</span></td>
        <td>
          <button class="btn secondary btn-small" data-action="edit-visit" data-visit-id="${v.id}">編集</button>
          <button class="btn secondary btn-small" data-action="open-note" data-visit-id="${v.id}">
            ${hasNote ? "記録を編集" : "記録入力"}
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll("button[data-action='edit-visit']").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.dataset.visitId;
        const v = appState.visits.find(v => v.id === id);
        if (!v) return;
        document.getElementById("visit-id").value = v.id;
        const d = v.startAt ? v.startAt.slice(0, 10) : "";
        const dt = v.startAt ? new Date(v.startAt) : null;
        const et = v.endAt ? new Date(v.endAt) : null;
        document.getElementById("visit-date").value = d;
        document.getElementById("visit-start-time").value = dt ? dt.toISOString().slice(11, 16) : "";
        document.getElementById("visit-end-time").value = et ? et.toISOString().slice(11, 16) : "";
        document.getElementById("visit-type").value = v.type || "regular";
        document.getElementById("visit-nurse").value = v.nurse || "";
        document.getElementById("visit-memo").value = v.memo || "";
      });
    });

    tbody.querySelectorAll("button[data-action='open-note']").forEach(btn => {
      btn.addEventListener("click", () => {
        const visitId = btn.dataset.visitId;
        openVisitNote(visitId);
      });
    });
  }

  function resetVisitForm() {
    document.getElementById("visit-id").value = "";
    document.getElementById("visit-date").value = todayISODate();
    document.getElementById("visit-start-time").value = "09:00";
    document.getElementById("visit-end-time").value = "09:30";
    document.getElementById("visit-type").value = "regular";
    document.getElementById("visit-nurse").value = currentUser ? currentUser.name : "";
    document.getElementById("visit-memo").value = "";
  }

  function renderPatientVitals() {
    const tbody = document.getElementById("vitals-table-body");
    tbody.innerHTML = "";
    const vitals = appState.vitals
      .filter(v => v.patientId === currentPatientId)
      .sort((a, b) => (a.measuredAt > b.measuredAt ? -1 : 1));
    vitals.slice(0, 50).forEach(v => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${formatDateTime(v.measuredAt)}</td>
        <td>${v.temp != null ? v.temp.toFixed(1) : ""}</td>
        <td>${v.bpSys != null ? v.bpSys : ""}/${v.bpDia != null ? v.bpDia : ""}</td>
        <td>${v.pulse != null ? v.pulse : ""}</td>
        <td>${v.spo2 != null ? v.spo2 : ""}</td>
      `;
      tbody.appendChild(tr);
    });
    renderVitalsChart();
  }

  function renderVitalsChart() {
    const ctx = document.getElementById("vitals-chart").getContext("2d");
    const vitals = appState.vitals
      .filter(v => v.patientId === currentPatientId && v.temp != null)
      .sort((a, b) => (a.measuredAt > b.measuredAt ? 1 : -1));

    const labels = vitals.map(v => {
      const d = new Date(v.measuredAt);
      return `${d.getMonth() + 1}/${d.getDate()} ${("0" + d.getHours()).slice(-2)}:${("0" + d.getMinutes()).slice(-2)}`;
    });
    const temps = vitals.map(v => v.temp);

    if (vitalsChart) {
      vitalsChart.destroy();
    }
    vitalsChart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "体温(℃)",
          data: temps,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            suggestedMin: 35,
            suggestedMax: 40
          }
        }
      }
    });
  }

  function renderPatientPhotos() {
    const grid = document.getElementById("photo-grid");
    grid.innerHTML = "";
    const photos = appState.photos
      .filter(ph => ph.patientId === currentPatientId)
      .sort((a, b) => (a.createdAt > b.createdAt ? -1 : 1));
    if (photos.length === 0) {
      grid.innerHTML = `<div class="small-text">登録済みの写真はありません。</div>`;
      return;
    }
    photos.forEach(ph => {
      const card = document.createElement("div");
      card.className = "photo-card";
      const img = document.createElement("img");
      img.src = ph.dataUrl;
      const meta = document.createElement("div");
      const d = new Date(ph.createdAt);
      const when = `${d.getMonth() + 1}/${d.getDate()} ${("0" + d.getHours()).slice(-2)}:${("0" + d.getMinutes()).slice(-2)}`;
      meta.innerHTML = `
        <div>${when}</div>
        <div>${(ph.tags || []).map(t => `<span class="chip">${t}</span>`).join("")}</div>
        <div>${ph.comment || ""}</div>
      `;
      card.appendChild(img);
      card.appendChild(meta);
      grid.appendChild(card);
    });
  }

  function openPatientDetail(patientId) {
    currentPatientId = patientId;
    renderPatientDetailBasic();
    renderPatientVisits();
    renderPatientVitals();
    renderPatientPhotos();
    switchPatientDetailTab("detail-visits");
    showView("view-patient-detail");
  }

  function initPatientDetail() {
    document.querySelectorAll("#view-patient-detail .tab").forEach(tab => {
      tab.addEventListener("click", () => {
        switchPatientDetailTab(tab.dataset.tab);
        if (tab.dataset.tab === "detail-vitals") {
          renderPatientVitals();
        } else if (tab.dataset.tab === "detail-photos") {
          renderPatientPhotos();
        } else if (tab.dataset.tab === "detail-visits") {
          renderPatientVisits();
        }
      });
    });

    document.getElementById("btn-new-visit").addEventListener("click", () => {
      resetVisitForm();
    });
    document.getElementById("visit-reset-btn").addEventListener("click", () => {
      resetVisitForm();
    });

    document.getElementById("visit-form").addEventListener("submit", e => {
      e.preventDefault();
      if (!currentPatientId) {
        alert("利用者が選択されていません。");
        return;
      }
      const id = document.getElementById("visit-id").value || genId();
      const date = document.getElementById("visit-date").value;
      const startTime = document.getElementById("visit-start-time").value;
      const endTime = document.getElementById("visit-end-time").value;
      if (!date || !startTime) {
        alert("日付と開始時刻は必須です。");
        return;
      }
      const type = document.getElementById("visit-type").value || "regular";
      const nurse = document.getElementById("visit-nurse").value || (currentUser ? currentUser.name : "");
      const memo = document.getElementById("visit-memo").value || "";
      const startAt = new Date(date + "T" + startTime + ":00");
      const endAt = endTime ? new Date(date + "T" + endTime + ":00") : null;

      // ダブルブッキング簡易チェック
      const overlap = appState.visits.some(v => {
        if (v.id === id || v.nurse !== nurse) return false;
        const s = new Date(v.startAt);
        const e = v.endAt ? new Date(v.endAt) : null;
        if (!e || !endAt) return false;
        return s < endAt && startAt < e;
      });
      if (overlap && !confirm("同一担当者の時間帯が重複しています。それでも保存しますか？")) {
        return;
      }

      const existing = appState.visits.find(v => v.id === id);
      if (existing) {
        existing.patientId = currentPatientId;
        existing.startAt = startAt.toISOString();
        existing.endAt = endAt ? endAt.toISOString() : null;
        existing.type = type;
        existing.nurse = nurse;
        existing.memo = memo;
      } else {
        appState.visits.push({
          id,
          patientId: currentPatientId,
          startAt: startAt.toISOString(),
          endAt: endAt ? endAt.toISOString() : null,
          type,
          nurse,
          status: "scheduled",
          memo
        });
      }
      saveState();
      renderPatientVisits();
      renderDashboard();
      alert("訪問予定を保存しました。");
      resetVisitForm();
    });

    document.getElementById("vital-form").addEventListener("submit", e => {
      e.preventDefault();
      if (!currentPatientId) {
        alert("利用者が選択されていません。");
        return;
      }
      const dt = document.getElementById("vital-datetime").value;
      if (!dt) {
        alert("測定日時は必須です。");
        return;
      }
      const temp = parseFloat(document.getElementById("vital-temp").value);
      const bpSys = parseInt(document.getElementById("vital-bp-sys").value, 10);
      const bpDia = parseInt(document.getElementById("vital-bp-dia").value, 10);
      const pulse = parseInt(document.getElementById("vital-pulse").value, 10);
      const spo2 = parseInt(document.getElementById("vital-spo2").value, 10);
      appState.vitals.push({
        id: genId(),
        patientId: currentPatientId,
        visitId: currentVisitId || null,
        measuredAt: new Date(dt).toISOString(),
        temp: isNaN(temp) ? null : temp,
        bpSys: isNaN(bpSys) ? null : bpSys,
        bpDia: isNaN(bpDia) ? null : bpDia,
        pulse: isNaN(pulse) ? null : pulse,
        spo2: isNaN(spo2) ? null : spo2
      });
      saveState();
      renderPatientVitals();
      alert("バイタルを追加しました。");
      e.target.reset();
    });

    document.getElementById("photo-form").addEventListener("submit", e => {
      e.preventDefault();
      if (!currentPatientId) {
        alert("利用者が選択されていません。");
        return;
      }
      const fileInput = document.getElementById("photo-file");
      const file = fileInput.files[0];
      if (!file) {
        alert("写真ファイルを選択してください。");
        return;
      }
      const tagsRaw = document.getElementById("photo-tags").value;
      const tags = tagsRaw
        .split(",")
        .map(t => t.trim())
        .filter(Boolean);
      const comment = document.getElementById("photo-comment").value || "";
      const reader = new FileReader();
      reader.onload = function(ev) {
        const dataUrl = ev.target.result;
        appState.photos.push({
          id: genId(),
          patientId: currentPatientId,
          visitId: currentVisitId || null,
          dataUrl,
          tags,
          comment,
          createdAt: new Date().toISOString()
        });
        saveState();
        renderPatientPhotos();
        alert("写真を保存しました。");
        fileInput.value = "";
        document.getElementById("photo-tags").value = "";
        document.getElementById("photo-comment").value = "";
      };
      reader.readAsDataURL(file);
    });
  }

  // --- 訪問記録 --------------------------------------------------------

  function openVisitNote(visitId) {
    currentVisitId = visitId;
    const visit = appState.visits.find(v => v.id === visitId);
    const patient = visit ? appState.patients.find(p => p.id === visit.patientId) : null;
    const header = document.getElementById("visit-note-header");
    if (visit && patient) {
      header.textContent = `${patient.lastName} ${patient.firstName} / ${formatDateTime(visit.startAt)} / ${
        visit.type === "regular" ? "定期" : visit.type === "oncall" ? "オンコール" : "緊急"
      }`;
      currentPatientId = patient.id; // 記録から利用者に戻るため
    } else {
      header.textContent = "";
    }
    const note = appState.visitNotes.find(n => n.visitId === visitId);
    document.getElementById("note-subjective").value = note ? note.subjective : "";
    document.getElementById("note-objective").value = note ? note.objective : "";
    document.getElementById("note-assessment").value = note ? note.assessment : "";
    document.getElementById("note-plan").value = note ? note.plan : "";
    document.getElementById("note-free").value = note ? note.freeText : "";
    showView("view-visit-note");
  }

  function initVisitNote() {
    document.getElementById("visit-note-form").addEventListener("submit", e => {
      e.preventDefault();
      if (!currentVisitId || !currentPatientId) {
        alert("訪問情報が見つかりません。");
        return;
      }
      const subjective = document.getElementById("note-subjective").value;
      const objective = document.getElementById("note-objective").value;
      const assessment = document.getElementById("note-assessment").value;
      const plan = document.getElementById("note-plan").value;
      const freeText = document.getElementById("note-free").value;
      let note = appState.visitNotes.find(n => n.visitId === currentVisitId);
      if (note) {
        note.subjective = subjective;
        note.objective = objective;
        note.assessment = assessment;
        note.plan = plan;
        note.freeText = freeText;
        note.updatedAt = new Date().toISOString();
      } else {
        appState.visitNotes.push({
          id: genId(),
          visitId: currentVisitId,
          patientId: currentPatientId,
          subjective,
          objective,
          assessment,
          plan,
          freeText,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        });
      }
      saveState();
      alert("訪問記録を保存しました。");
      // 利用者詳細へ戻る
      if (currentPatientId) {
        openPatientDetail(currentPatientId);
      } else {
        showView("view-dashboard");
      }
    });

    document.getElementById("btn-note-back").addEventListener("click", () => {
      if (currentPatientId) {
        openPatientDetail(currentPatientId);
      } else {
        showView("view-dashboard");
      }
    });
  }

  // --- ナビゲーション ---------------------------------------------------

  function initNavigation() {
    document.getElementById("nav-to-patients").addEventListener("click", () => {
      renderPatientsList();
      showView("view-patients");
    });

    document.getElementById("nav-to-schedule").addEventListener("click", () => {
      renderScheduleView();
      showView("view-schedule");
    });

    document.getElementById("btn-schedule-back").addEventListener("click", () => {
      renderDashboard();
      showView("view-dashboard");
    });
  }

  // --- 初期化 ----------------------------------------------------------

  function initApp() {
    initLogin();
    initPatients();
    initPatientDetail();
    initVisitNote();
    initNavigation();
    updateHeader();
    renderDashboard();
  }

  document.addEventListener("DOMContentLoaded", initApp);
</script>
</body>
</html>
