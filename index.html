<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>CareNexus AI (Ultimate Edition)</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* ========== CSS (Base Design Preserved & Extended) ========== */
:root { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif; color: #111827; background: #f3f4f6; --primary: #2563eb; --danger: #ef4444; --success: #10b981; --warning: #f59e0b; }
body { margin: 0; background: #f3f4f6; user-select: none; -webkit-tap-highlight-color: transparent; }
.app { max-width: 1200px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; transition: filter 0.3s; }

/* Security Overlay */
.blur-mode { filter: blur(10px); pointer-events: none; }
#loginOverlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
.login-box { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; width: 300px; border: 1px solid #e5e7eb; }
.pin-dots { display: flex; gap: 10px; justify-content: center; margin: 20px 0; }
.pin-dot { width: 12px; height: 12px; border-radius: 50%; background: #d1d5db; transition: 0.2s; }
.pin-dot.filled { background: var(--primary); transform: scale(1.2); }

/* Header & Connectivity */
header { position: sticky; top: 0; z-index: 50; backdrop-filter: blur(16px); background: rgba(243, 244, 246, 0.95); border-bottom: 1px solid #e5e7eb; padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
.logo { font-weight: 700; font-size: 18px; display: flex; align-items: center; gap: 8px; color: #1f2937; }
.header-right { display: flex; align-items: center; gap: 10px; }
.connection-status { font-size: 11px; padding: 4px 8px; border-radius: 4px; font-weight: bold; display: flex; align-items: center; gap: 4px; cursor: pointer; }
.status-online { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
.status-offline { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

/* Navigation Tabs (Scrollable) */
main { padding: 16px; flex: 1; padding-bottom: 80px; /* Mobile safe area */ }
.tabs { display: flex; border-radius: 12px; background: #e5e7eb; padding: 4px; margin-bottom: 16px; overflow-x: auto; gap: 4px; scrollbar-width: none; }
.tabs::-webkit-scrollbar { display: none; }
.tab { flex: 1; text-align: center; padding: 10px 16px; font-size: 13px; border-radius: 8px; cursor: pointer; white-space: nowrap; color: #6b7280; font-weight: 500; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; }
.tab.active { background: #ffffff; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); font-weight: 700; color: var(--primary); }
.section { display: none; animation: fadeIn 0.3s ease; }
.section.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

/* Panels & Cards */
.two-column { display: grid; grid-template-columns: 1fr; gap: 16px; }
@media (min-width: 900px) { .two-column { grid-template-columns: 1fr 1fr; } }
.panel { border-radius: 16px; background: #ffffff; padding: 20px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.04); border: 1px solid #e5e7eb; position: relative; }
.panel-title { font-size: 16px; font-weight: 700; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; color: #111827; }

/* Components */
.btn { border-radius: 8px; border: none; padding: 10px 16px; font-size: 13px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-weight: 600; transition: all 0.2s; text-decoration: none; }
.btn:active { transform: scale(0.98); }
.btn-primary { background: var(--primary); color: #ffffff; box-shadow: 0 2px 5px rgba(37, 99, 235, 0.3); }
.btn-danger { background: var(--danger); color: white; }
.btn-outline { background: #ffffff; color: #374151; border: 1px solid #d1d5db; }
.btn-icon { padding: 8px; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; }

textarea, input, select { width: 100%; border-radius: 8px; border: 1px solid #d1d5db; font-size: 14px; padding: 12px; box-sizing: border-box; margin-top: 4px; background: #f9fafb; transition: 0.2s; }
textarea:focus, input:focus { background: white; border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

/* Custom Features UI */
/* Map & Route */
.map-wrapper { position: relative; height: 350px; border-radius: 12px; overflow: hidden; border: 1px solid #dbeafe; }
.ai-route-overlay { position: absolute; bottom: 12px; right: 12px; z-index: 10; background: rgba(255,255,255,0.9); padding: 8px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; gap: 8px; }

/* Calendar */
.calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 10px; }
.cal-day { aspect-ratio: 1; background: #f9fafb; border-radius: 6px; border: 1px solid #f3f4f6; display: flex; flex-direction: column; padding: 4px; font-size: 12px; position: relative; }
.cal-day.today { border: 2px solid var(--primary); background: #eff6ff; }
.cal-event { font-size: 9px; padding: 2px 4px; border-radius: 3px; margin-top: 2px; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
/* Photo & Schema */
.media-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; margin-top: 12px; }
.media-item { aspect-ratio: 1; background: #eee; border-radius: 8px; display: flex; align-items: center; justify-content: center; position: relative; cursor: pointer; overflow: hidden; }
.media-item img { width: 100%; height: 100%; object-fit: cover; }
.schema-canvas { border: 1px solid #ddd; background: #fff url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="30" r="10" fill="none" stroke="%23ccc"/><line x1="50" y1="40" x2="50" y2="70" stroke="%23ccc"/><line x1="50" y1="50" x2="30" y2="60" stroke="%23ccc"/><line x1="50" y1="50" x2="70" y2="60" stroke="%23ccc"/><line x1="50" y1="70" x2="40" y2="90" stroke="%23ccc"/><line x1="50" y1="70" x2="60" y2="90" stroke="%23ccc"/></svg>') no-repeat center; background-size: contain; width: 100%; height: 250px; touch-action: none; border-radius: 8px; }

/* Typing Animation (AI) */
.typing::after { content: '|'; animation: blink 1s infinite; color: var(--primary); }
@keyframes blink { 50% { opacity: 0; } }

/* Responsive Adjustments */
@media (max-width: 600px) {
    .tabs { flex-wrap: nowrap; justify-content: flex-start; }
    .header-right span { display: none; }
}
</style>
</head>
<body>

<div id="loginOverlay">
    <div class="logo" style="margin-bottom: 20px; font-size: 24px;">
        <i class="fa-solid fa-heart-pulse" style="color: #2563eb;"></i> CareNexus AI
    </div>
    <div class="login-box">
        <h3 style="margin:0 0 10px 0;">スタッフ認証</h3>
        <p style="font-size:12px; color:#666;">セキュリティのためパスコードを入力してください<br>(デモ用: 0000)</p>
        <div class="pin-dots" id="pinDots">
            <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
        </div>
        <input type="password" id="pinInput" maxlength="4" style="text-align:center; letter-spacing:10px; font-size:24px; width:100%;" inputmode="numeric" autofocus>
    </div>
</div>

<div class="app" id="appContainer">
    <header>
        <div class="logo">
            <i class="fa-solid fa-heart-pulse" style="color: #2563eb;"></i>
            <span>CareNexus AI</span>
        </div>
        <div class="header-right">
            <div id="connectionStatus" class="connection-status status-online" onclick="toggleOfflineMode()">
                <i class="fa-solid fa-wifi"></i> <span>オンライン</span>
            </div>
            <button class="btn btn-outline" style="padding:6px 10px;" onclick="lockScreen()">
                <i class="fa-solid fa-lock"></i>
            </button>
        </div>
    </header>

    <main>
        <div class="tabs">
            <div class="tab active" data-tab="list"><i class="fa-solid fa-list-check"></i> 訪問予定</div>
            <div class="tab" data-tab="schedule"><i class="fa-regular fa-calendar"></i> カレンダー</div>
            <div class="tab" data-tab="record"><i class="fa-solid fa-file-medical"></i> 記録/AI</div>
            <div class="tab" data-tab="vitals"><i class="fa-solid fa-chart-line"></i> バイタル</div>
            <div class="tab" data-tab="patient"><i class="fa-solid fa-user"></i> 利用者</div>
            <div class="tab" data-tab="report"><i class="fa-solid fa-file-contract"></i> 報告書</div>
            <div class="tab" data-tab="admin"><i class="fa-solid fa-sliders"></i> 経営/管理</div>
        </div>

        <section id="section-list" class="section active">
            <div class="two-column">
                <div class="panel">
                    <div class="panel-title">
                        本日の訪問 (AI優先度順)
                        <span style="font-size:12px; font-weight:normal; background:#dcfce7; padding:2px 8px; border-radius:12px; color:#166534;">最適化済</span>
                    </div>
                    <div class="visit-list" id="visitList"></div>
                </div>
                <div class="panel">
                    <div class="panel-title">動態管理・ルート</div>
                    <div class="map-wrapper" id="mapContainer">
                        <div style="position:absolute; inset:0; background: #e0f2fe; display:flex; align-items:center; justify-content:center; color:#bae6fd; font-weight:bold; font-size:40px; opacity:0.5;">MAP</div>
                        <div id="mapMarkers"></div>
                        <div class="ai-route-overlay">
                            <button class="btn btn-primary" onclick="optimizeRoute()">
                                <i class="fa-solid fa-wand-magic-sparkles"></i> AIルート再構築
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="section-schedule" class="section">
            <div class="panel">
                <div class="panel-title">
                    <div>
                        <span style="font-size:18px;">2025年 12月</span>
                        <button class="btn btn-outline" style="margin-left:8px; padding:4px 8px;"><i class="fa-solid fa-chevron-left"></i></button>
                        <button class="btn btn-outline" style="padding:4px 8px;"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                    <button class="btn btn-primary"><i class="fa-solid fa-plus"></i> 新規予定</button>
                </div>
                <div class="calendar-grid" id="calendarGrid">
                    </div>
            </div>
        </section>

        <section id="section-record" class="section">
            <div class="two-column">
                <div class="panel">
                    <div class="panel-title">
                        <span id="recordTitle">記録入力</span>
                        <select id="recordPatientSelect" style="width:auto; padding:4px; font-size:12px;"></select>
                    </div>
                    
                    <div style="display:flex; gap:8px; margin-bottom:8px;">
                        <button class="btn btn-outline" onclick="alert('カメラ起動：写真を撮影します')"><i class="fa-solid fa-camera"></i></button>
                        <button class="btn btn-outline" onclick="document.getElementById('fileInput').click()"><i class="fa-regular fa-image"></i></button>
                        <button class="btn btn-outline" onclick="toggleSchema()"><i class="fa-solid fa-pen-nib"></i> シェーマ</button>
                        <input type="file" id="fileInput" style="display:none;" onchange="handleFileSelect(this)">
                    </div>

                    <div id="schemaArea" style="display:none; margin-bottom:10px;">
                        <div class="schema-canvas" id="schemaCanvas"></div>
                        <div style="text-align:right; margin-top:4px;">
                            <button class="btn btn-outline" style="font-size:11px;" onclick="clearSchema()">クリア</button>
                        </div>
                    </div>

                    <div id="mediaPreview" class="media-grid"></div>

                    <div class="field-label">メモ・発話内容 (音声入力対応)</div>
                    <textarea id="freeText" placeholder="例: 14:00訪問。BP130/80。足のむくみ軽減。本人は食欲ありと話す。"></textarea>
                    
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:12px;">
                        <button id="voiceInputBtn" class="btn btn-outline"><i class="fa-solid fa-microphone"></i> 音声入力</button>
                        <button class="btn btn-primary" id="btnGenerate" onclick="runAIDemo()">
                            <i class="fa-solid fa-robot"></i> AI生成実行
                        </button>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-title">AI生成結果 (Simulation)</div>
                    <div class="field-label">看護診断・問題点</div>
                    <div id="diagnosisArea" class="ai-result-box" style="padding:10px; background:#ecfdf5; border-radius:6px; color:#065f46; font-weight:bold; min-height:40px;">---</div>
                    
                    <div class="field-label">SOAP記録 (自動構成)</div>
                    <div id="soapArea" class="ai-result-box" style="padding:10px; background:#f9fafb; border:1px solid #ddd; border-radius:6px; white-space:pre-wrap; min-height:80px; font-size:13px;">---</div>
                    
                    <div class="field-label">家族・連携用サマリー</div>
                    <div id="familyReportText" class="ai-result-box" style="padding:10px; background:#eff6ff; border-radius:6px; color:#1e40af; font-size:13px;">---</div>
                </div>
            </div>
            
            <div class="panel" style="margin-top:16px;">
                <div class="panel-title">多職種連携チャット (MCS連携)</div>
                <div id="chatArea" style="max-height:150px; overflow-y:auto; border:1px solid #e5e7eb; padding:10px; border-radius:8px; background:#f9fafb;">
                    </div>
                <div style="display:flex; gap:8px; margin-top:8px;">
                    <input type="text" id="chatInput" placeholder="メッセージ..." style="margin:0;">
                    <button class="btn btn-primary" onclick="sendChat()">送信</button>
                </div>
            </div>
        </section>

        <section id="section-vitals" class="section">
            <div class="panel">
                <div class="panel-title">
                    <span id="vitalTitle">バイタル詳細分析</span>
                    <button class="btn btn-outline" style="font-size:11px;" onclick="simulateBluetooth()"><i class="fa-brands fa-bluetooth"></i> 機器連携</button>
                </div>
                <div style="height:300px; width:100%;">
                    <canvas id="chart_vitals"></canvas>
                </div>
            </div>
        </section>

        <section id="section-patient" class="section">
            <div class="two-column">
                <div class="panel">
                    <div class="panel-title">利用者一覧</div>
                    <div id="patientListSelect" style="display:flex; flex-direction:column; gap:8px;"></div>
                </div>
                <div class="panel">
                    <div class="panel-title">基本情報編集</div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                        <input id="pt_name" placeholder="氏名">
                        <input id="pt_age" placeholder="年齢">
                        <div style="grid-column:1/-1"><input id="pt_address" placeholder="住所"></div>
                        <div style="grid-column:1/-1"><textarea id="pt_history" placeholder="既往歴" style="height:60px;"></textarea></div>
                    </div>
                    <button class="btn btn-primary" style="margin-top:12px;" onclick="alert('保存しました')">更新保存</button>
                </div>
            </div>
        </section>

        <section id="section-report" class="section">
            <div class="two-column">
                <div class="panel">
                    <div class="panel-title">帳票作成</div>
                    <div style="display:flex; flex-direction:column; gap:10px;">
                        <button class="btn btn-outline" onclick="generateReport('plan')"><i class="fa-solid fa-file-pen"></i> 訪問看護計画書 (作成)</button>
                        <button class="btn btn-outline" onclick="generateReport('report')"><i class="fa-solid fa-file-export"></i> 訪問看護報告書 (月次)</button>
                        <button class="btn btn-outline" onclick="generateReport('info')"><i class="fa-solid fa-user-doctor"></i> 情報提供書</button>
                    </div>
                </div>
                <div class="panel" id="reportPreviewPanel" style="display:none; background:#525252;">
                    <div class="panel-title" style="color:white; border-bottom:1px solid #777;">
                        プレビュー
                        <button class="btn btn-primary" style="padding:4px 8px; font-size:11px;">印刷 / PDF</button>
                    </div>
                    <div style="background:white; height:300px; margin-top:10px; padding:20px; font-size:10px; overflow:hidden; position:relative;">
                        <div style="text-align:center; font-size:14px; font-weight:bold; margin-bottom:10px;">訪問看護報告書</div>
                        <div style="border:1px solid #000; height:80%;">
                            <div style="border-bottom:1px solid #000; padding:5px;">利用者名: <span id="reportPtName">田中 太郎</span></div>
                            <div style="padding:5px;">
                                <p>【病状の経過】<br>バイタル安定。浮腫軽減傾向。...</p>
                                <p>【看護の内容】<br>・健康状態の観察<br>・清潔保持...</p>
                            </div>
                        </div>
                        <div style="position:absolute; bottom:10px; right:20px; color:red; border:2px solid red; padding:2px 8px; transform:rotate(-15deg); opacity:0.3; font-weight:bold; font-size:20px;">SAMPLE</div>
                    </div>
                </div>
            </div>
        </section>

        <section id="section-admin" class="section">
            <div class="panel">
                <div class="panel-title">経営ダッシュボード & HR分析</div>
                <div class="two-column">
                    <div style="background:#f9fafb; padding:15px; border-radius:8px;">
                        <div style="font-size:12px; color:#666;">今月の売上見込</div>
                        <div style="font-size:24px; font-weight:bold; color:#111827;">¥ 4,820,000</div>
                        <div style="font-size:11px; color:#10b981;"><i class="fa-solid fa-arrow-trend-up"></i> 前月比 +12%</div>
                    </div>
                    <div style="background:#f9fafb; padding:15px; border-radius:8px;">
                        <div style="font-size:12px; color:#666;">スタッフ稼働率</div>
                        <div style="font-size:24px; font-weight:bold; color:#111827;">88.5%</div>
                        <div style="font-size:11px; color:#f59e0b;"><i class="fa-solid fa-triangle-exclamation"></i> 過重労働注意</div>
                    </div>
                </div>
                <div style="margin-top:20px;">
                    <div class="field-label">スタッフ離職リスク分析 (AI予兆検知)</div>
                    <div id="staffRiskList" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap:10px; margin-top:8px;">
                        </div>
                </div>
            </div>
        </section>
    </main>
</div>

<script>
/* =========================================
   Data & State
   ========================================= */
const patients = [
    { id: 1, name: "田中 太郎", age: 82, address: "新宿区西新宿2-8-1", loc: {x:30, y:40}, priority: "high", status: "要介護3" },
    { id: 2, name: "佐藤 花子", age: 78, address: "港区芝公園4-2-8", loc: {x:60, y:20}, priority: "mid", status: "要介護5" },
    { id: 3, name: "鈴木 一郎", age: 65, address: "世田谷区北沢1-1", loc: {x:40, y:70}, priority: "low", status: "要介護2" }
];

let isOffline = false;
let currentTab = 'list';

/* =========================================
   1. Security & Login Logic
   ========================================= */
const pinInput = document.getElementById('pinInput');
const dots = document.querySelectorAll('.pin-dot');

pinInput.addEventListener('input', (e) => {
    const val = e.target.value;
    dots.forEach((dot, idx) => {
        if (idx < val.length) dot.classList.add('filled');
        else dot.classList.remove('filled');
    });
    if (val.length === 4) {
        if(val === "0000") {
            document.getElementById('loginOverlay').style.opacity = 0;
            setTimeout(() => document.getElementById('loginOverlay').style.display = "none", 300);
        } else {
            alert("PINが違います (0000)");
            pinInput.value = "";
            dots.forEach(d => d.classList.remove('filled'));
        }
    }
});

function lockScreen() {
    document.getElementById('loginOverlay').style.display = "flex";
    document.getElementById('loginOverlay').style.opacity = 1;
    pinInput.value = "";
    dots.forEach(d => d.classList.remove('filled'));
    pinInput.focus();
}

/* =========================================
   2. Tab Switching
   ========================================= */
document.querySelectorAll('.tab').forEach(t => {
    t.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        t.classList.add('active');
        document.getElementById('section-' + t.dataset.tab).classList.add('active');
        currentTab = t.dataset.tab;
    });
});

/* =========================================
   3. Initialization & Rendering
   ========================================= */
function init() {
    renderVisitList();
    renderMap();
    renderCalendar();
    renderStaffRisk();
    
    // Patient Select Options
    const sel = document.getElementById('recordPatientSelect');
    const listSel = document.getElementById('patientListSelect');
    patients.forEach(p => {
        // Dropdown
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.name;
        sel.appendChild(opt);
        // List Item
        const div = document.createElement('div');
        div.className = "btn btn-outline";
        div.style.justifyContent = "space-between";
        div.innerHTML = `<span>${p.name}</span> <span style="font-size:10px; background:#eee; padding:2px 6px; border-radius:4px;">${p.status}</span>`;
        div.onclick = () => {
            document.getElementById('pt_name').value = p.name;
            document.getElementById('pt_age').value = p.age + "歳";
            document.getElementById('pt_address').value = p.address;
        };
        listSel.appendChild(div);
    });

    // Chat Demo Init
    addChatBubble("Dr. 佐藤", "田中様の血糖値、本日のデータを見てインスリン量を調整します。", true);
}

/* =========================================
   4. Functionality Implementations
   ========================================= */

// --- Visit List & Map ---
function renderVisitList() {
    const el = document.getElementById('visitList');
    el.innerHTML = "";
    patients.forEach(p => {
        const div = document.createElement('div');
        div.className = "btn btn-outline";
        div.style.display = "flex";
        div.style.marginBottom = "8px";
        div.style.justifyContent = "space-between";
        div.style.borderLeft = p.priority === "high" ? "4px solid var(--danger)" : "4px solid #ddd";
        div.innerHTML = `
            <div>
                <div style="font-weight:bold;">${p.name}</div>
                <div style="font-size:11px; color:#666;">${p.address}</div>
            </div>
            <button class="btn btn-primary" style="padding:4px 8px; font-size:11px;">記録</button>
        `;
        el.appendChild(div);
    });
}

function renderMap() {
    const el = document.getElementById('mapMarkers');
    el.innerHTML = "";
    patients.forEach((p, idx) => {
        const pin = document.createElement('div');
        pin.style.position = "absolute";
        pin.style.left = p.loc.x + "%";
        pin.style.top = p.loc.y + "%";
        pin.style.width = "24px";
        pin.style.height = "24px";
        pin.style.background = p.priority === "high" ? "var(--danger)" : "var(--primary)";
        pin.style.color = "white";
        pin.style.borderRadius = "50%";
        pin.style.display = "flex";
        pin.style.alignItems = "center";
        pin.style.justifyContent = "center";
        pin.style.fontSize = "12px";
        pin.style.fontWeight = "bold";
        pin.style.boxShadow = "0 2px 4px rgba(0,0,0,0.2)";
        pin.innerText = idx + 1;
        el.appendChild(pin);
    });
}

function optimizeRoute() {
    alert("AIが交通状況と利用者様態を分析し、最適なルートを再構築しました。\n(移動時間 -15分 短縮見込)");
    // Demo visual update
    document.getElementById('visitList').style.opacity = 0.5;
    setTimeout(() => document.getElementById('visitList').style.opacity = 1, 300);
}

// --- Calendar ---
function renderCalendar() {
    const grid = document.getElementById('calendarGrid');
    for(let i=1; i<=31; i++) {
        const day = document.createElement('div');
        day.className = "cal-day" + (i === 16 ? " today" : "");
        day.innerHTML = `<span>${i}</span>`;
        if(i % 3 === 0) day.innerHTML += `<div class="cal-event" style="background:var(--primary);">田中様</div>`;
        if(i % 4 === 0) day.innerHTML += `<div class="cal-event" style="background:var(--warning);">会議</div>`;
        grid.appendChild(day);
    }
}

// --- Records & Multimedia ---
function handleFileSelect(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const div = document.createElement('div');
            div.className = "media-item";
            div.innerHTML = `<img src="${e.target.result}">`;
            document.getElementById('mediaPreview').appendChild(div);
        }
        reader.readAsDataURL(input.files[0]);
    }
}

function toggleSchema() {
    const area = document.getElementById('schemaArea');
    area.style.display = area.style.display === "none" ? "block" : "none";
}
function clearSchema() {
    // In real app, clear canvas logic
    alert("シェーマをクリアしました");
}

function runAIDemo() {
    const btn = document.getElementById('btnGenerate');
    btn.disabled = true;
    btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> 生成中...`;
    
    // Simulate thinking
    setTimeout(() => {
        typeWriter('diagnosisArea', "1. 体液量均衡過剰の疑い (浮腫)\n2. 転倒リスク (歩行不安定)");
        setTimeout(() => typeWriter('soapArea', "**S:** 「足が楽になった」\n**O:** 浮腫軽減(+1)。BP安定。\n**A:** 利尿剤の効果あり。経過良好。\n**P:** 継続観察。"), 500);
        setTimeout(() => typeWriter('familyReportText', "足のむくみは少し良くなっています。ご本人も楽だとおっしゃっていました。転倒には引き続きご注意ください。"), 1000);
        
        btn.disabled = false;
        btn.innerHTML = `<i class="fa-solid fa-robot"></i> AI生成実行`;
    }, 1500);
}

function typeWriter(id, text) {
    const el = document.getElementById(id);
    el.innerHTML = "";
    el.classList.add("typing");
    let i = 0;
    const interval = setInterval(() => {
        el.innerHTML += text.charAt(i) === '\n' ? '<br>' : text.charAt(i);
        i++;
        if(i >= text.length) {
            clearInterval(interval);
            el.classList.remove("typing");
        }
    }, 30);
}

// --- Vitals & Devices ---
function simulateBluetooth() {
    alert("Bluetooth機器を検索中...\n\n[テルモ血圧計 P2020] に接続しました。\n数値を自動入力します。");
    // Chart update simulation could go here
}

// --- Chat ---
function addChatBubble(name, text, isLeft) {
    const area = document.getElementById('chatArea');
    const div = document.createElement('div');
    div.style.background = isLeft ? "#fff" : "#dbeafe";
    div.style.padding = "8px 12px";
    div.style.borderRadius = "8px";
    div.style.marginBottom = "8px";
    div.style.fontSize = "13px";
    div.style.alignSelf = isLeft ? "flex-start" : "flex-end";
    div.style.maxWidth = "80%";
    div.style.border = "1px solid #e5e7eb";
    div.innerHTML = `<div style="font-size:10px; color:#666; margin-bottom:2px;">${name}</div>${text}`;
    area.appendChild(div);
}
function sendChat() {
    const inp = document.getElementById('chatInput');
    if(inp.value) {
        addChatBubble("自分", inp.value, false);
        inp.value = "";
    }
}

// --- Reports ---
function generateReport(type) {
    document.getElementById('reportPreviewPanel').style.display = "block";
    document.getElementById('reportPtName').textContent = document.getElementById('pt_name').value || "田中 太郎";
}

// --- Offline Mode ---
function toggleOfflineMode() {
    isOffline = !isOffline;
    const status = document.getElementById('connectionStatus');
    if(isOffline) {
        status.className = "connection-status status-offline";
        status.innerHTML = `<i class="fa-solid fa-cloud-bolt"></i> オフライン`;
        alert("オフラインモードに切り替えました。\nデータは端末内に一時保存され、再接続時に自動同期されます。");
    } else {
        status.className = "connection-status status-online";
        status.innerHTML = `<i class="fa-solid fa-wifi"></i> オンライン`;
        alert("オンラインに復帰しました。\n保存されたデータをクラウドへ同期しました。");
    }
}

// --- Admin/Staff Risk ---
function renderStaffRisk() {
    const list = document.getElementById('staffRiskList');
    const staff = [
        { name: "山田 花子", risk: 80, reason: "残業過多 / 記録遅延" },
        { name: "佐藤 健", risk: 20, reason: "安定" }
    ];
    staff.forEach(s => {
        const div = document.createElement('div');
        div.style.border = "1px solid #ddd";
        div.style.borderRadius = "8px";
        div.style.padding = "10px";
        div.style.background = s.risk > 50 ? "#fef2f2" : "#fff";
        div.style.borderLeft = s.risk > 50 ? "4px solid red" : "4px solid green";
        div.innerHTML = `
            <div style="font-weight:bold; font-size:13px;">${s.name}</div>
            <div style="font-size:11px; margin-top:4px;">離職リスク: ${s.risk}%</div>
            <div style="font-size:10px; color:#666;">${s.reason}</div>
        `;
        list.appendChild(div);
    });
}

// --- Chart Init ---
const ctx = document.getElementById('chart_vitals').getContext('2d');
new Chart(ctx, {
    type: 'line',
    data: {
        labels: ['12/10', '12/11', '12/12', '12/13', '12/14'],
        datasets: [{
            label: '収縮期血圧',
            data: [138, 135, 142, 130, 128],
            borderColor: '#2563eb',
            tension: 0.3
        }, {
            label: '脈拍',
            data: [80, 82, 85, 78, 76],
            borderColor: '#f59e0b',
            tension: 0.3
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } }
    }
});

// Run Init
window.onload = init;
</script>
</body>
</html>
