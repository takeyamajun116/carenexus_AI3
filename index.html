<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CareNexus AI - Full EMR Integration</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* =========================================
       CSS: CareNexus Design System
       ========================================= */
    :root {
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --bg-body: #f3f4f6;
      --bg-panel: #ffffff;
      --text-main: #111827;
      --text-sub: #6b7280;
      --border: #e5e7eb;
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
    }
    body { margin: 0; background: var(--bg-body); color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; }
    
    /* Utility */
    .hidden { display: none !important; }
    .flex { display: flex; }
    .flex-col { flex-direction: column; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .gap-2 { gap: 8px; }
    .gap-4 { gap: 16px; }
    .w-full { width: 100%; }
    .mt-4 { margin-top: 16px; }
    .mb-4 { margin-bottom: 16px; }
    .text-sm { font-size: 13px; }
    .font-bold { font-weight: 700; }
    .text-gray { color: var(--text-sub); }

    /* Login Overlay */
    #login-overlay {
      position: fixed; inset: 0; z-index: 100;
      background: rgba(243, 244, 246, 0.95);
      backdrop-filter: blur(8px);
      display: flex; align-items: center; justify-content: center;
    }
    .login-card {
      background: #fff; padding: 32px; border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 360px;
      text-align: center; border: 1px solid var(--border);
    }

    /* Header */
    header {
      position: sticky; top: 0; z-index: 10;
      background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      padding: 12px 16px;
    }
    .brand { font-size: 18px; font-weight: 800; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
    .header-user { font-size: 12px; text-align: right; }

    /* Layout */
    .container { max-width: 1200px; margin: 0 auto; padding: 16px; width: 100%; box-sizing: border-box; }
    
    /* Navigation */
    .nav-tabs { display: flex; background: #e5e7eb; padding: 4px; border-radius: 8px; margin-bottom: 20px; overflow-x: auto; }
    .nav-item {
      flex: 1; text-align: center; padding: 10px; font-size: 13px; font-weight: 500;
      cursor: pointer; border-radius: 6px; color: var(--text-sub); transition: 0.2s; white-space: nowrap;
    }
    .nav-item:hover { color: var(--text-main); background: rgba(255,255,255,0.5); }
    .nav-item.active { background: #fff; color: var(--primary); font-weight: 700; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

    /* Panels & Cards */
    .panel { background: var(--bg-panel); border-radius: 12px; border: 1px solid var(--border); padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.02); }
    .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; border-bottom: 1px solid var(--border); padding-bottom: 12px; }
    .panel-title { font-size: 16px; font-weight: 700; color: #1f2937; }

    .card { background: #f9fafb; border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 8px; transition: 0.2s; cursor: pointer; }
    .card:hover { border-color: #d1d5db; background: #f3f4f6; }
    
    /* Forms */
    .form-group { margin-bottom: 12px; }
    label { display: block; font-size: 12px; font-weight: 600; color: #4b5563; margin-bottom: 4px; }
    input, select, textarea {
      width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #d1d5db;
      font-size: 14px; background: #fff; box-sizing: border-box; font-family: inherit;
    }
    textarea { resize: vertical; min-height: 80px; }
    input:focus, textarea:focus { outline: none; border-color: var(--primary); ring: 2px var(--primary); }

    /* Buttons */
    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 600;
      cursor: pointer; border: none; transition: 0.2s; gap: 6px;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-secondary { background: #fff; border: 1px solid #d1d5db; color: #374151; }
    .btn-secondary:hover { background: #f9fafb; }
    .btn-danger { background: #fee2e2; color: #dc2626; }
    .btn-sm { padding: 4px 10px; font-size: 12px; }

    /* Tables */
    .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .data-table th { text-align: left; padding: 12px; background: #f9fafb; border-bottom: 1px solid var(--border); color: var(--text-sub); font-weight: 600; }
    .data-table td { padding: 12px; border-bottom: 1px solid var(--border); }
    .data-table tr:last-child td { border-bottom: none; }
    .data-table tr:hover { background: #f9fafb; }

    /* Tags */
    .tag { padding: 2px 8px; border-radius: 999px; font-size: 11px; font-weight: 600; }
    .tag-blue { background: #dbeafe; color: #1e40af; }
    .tag-green { background: #dcfce7; color: #166534; }
    .tag-gray { background: #f3f4f6; color: #4b5563; }

    /* AI Typing Effect */
    .ai-box { background: #eff6ff; border: 1px solid #bfdbfe; color: #1e3a8a; }
    .typing::after { content: '|'; animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity: 0; } }
  </style>
</head>
<body>

<div id="login-overlay">
  <div class="login-card">
    <div style="margin-bottom: 20px;">
      <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
      <h2 style="margin: 8px 0 0; font-size: 20px;">CareNexus AI</h2>
      <p style="color:#6b7280; font-size:13px;">é›»å­ã‚«ãƒ«ãƒ†çµ±åˆã‚·ã‚¹ãƒ†ãƒ </p>
    </div>
    <form onsubmit="handleLogin(event)">
      <div class="form-group">
        <input type="text" id="login-id" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ID (ä¾‹: user)" value="user" required>
      </div>
      <div class="form-group">
        <input type="password" id="login-pw" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (ä¾‹: pass)" value="pass" required>
      </div>
      <button type="submit" class="btn btn-primary w-full">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <p id="login-error" style="color:#dc2626; font-size:12px; margin-top:8px; display:none;">IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™</p>
    </form>
  </div>
</div>

<div id="app-main" class="hidden">
  <header>
    <div class="container flex justify-between items-center" style="padding:0;">
      <div class="brand">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
        <span>CareNexus AI</span>
        <span class="tag tag-blue" style="margin-left:8px;">Full Edition</span>
      </div>
      <div class="header-user">
        <div id="display-username" class="font-bold">Ns. Yamada</div>
        <a href="#" onclick="handleLogout()" style="color:#ef4444; text-decoration:none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="nav-tabs">
      <div class="nav-item active" onclick="navigate('dashboard')" id="nav-dashboard">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
      <div class="nav-item" onclick="navigate('patients')" id="nav-patients">åˆ©ç”¨è€…ä¸€è¦§</div>
      <div class="nav-item" onclick="navigate('settings')" id="nav-settings">è¨­å®šãƒ»ãƒ‡ãƒ¼ã‚¿</div>
    </div>

    <div id="view-dashboard" class="view-section">
      <div class="flex flex-col md:flex-row gap-4">
        <div class="panel" style="flex:2;">
          <div class="panel-header">
            <span class="panel-title">æœ¬æ—¥ã®è¨ªå•äºˆå®š</span>
            <span class="tag tag-green" id="today-date"></span>
          </div>
          <div id="schedule-list">
            </div>
        </div>
        <div class="panel" style="flex:1;">
          <div class="panel-header"><span class="panel-title">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</span></div>
          <div class="card">
            <div class="text-sm font-bold">è¦ç¢ºèª</div>
            <div class="text-sm text-gray">æœªå®Œäº†ã®è¨˜éŒ²ãŒ 1 ä»¶ã‚ã‚Šã¾ã™ã€‚</div>
          </div>
          <div class="card">
            <div class="text-sm font-bold">AIã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ</div>
            <div class="text-sm text-gray">ç”Ÿæˆã‚¨ãƒ³ã‚¸ãƒ³ã®ç²¾åº¦ãŒå‘ä¸Šã—ã¾ã—ãŸã€‚</div>
          </div>
        </div>
      </div>
    </div>

    <div id="view-patients" class="view-section hidden">
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">åˆ©ç”¨è€…æ¤œç´¢ãƒ»ä¸€è¦§</span>
          <button class="btn btn-primary btn-sm" onclick="alert('ãƒ‡ãƒ¢ç‰ˆ: è¿½åŠ æ©Ÿèƒ½ã¯åˆ¶é™ã•ã‚Œã¦ã„ã¾ã™')">ï¼‹ æ–°è¦ç™»éŒ²</button>
        </div>
        <div class="flex gap-2 mb-4">
          <input type="text" id="patient-search" placeholder="æ°åã¾ãŸã¯IDã§æ¤œç´¢..." onkeyup="renderPatientList()">
        </div>
        <div style="overflow-x:auto;">
          <table class="data-table">
            <thead>
              <tr><th>ID</th><th>æ°å</th><th>å¹´é½¢/æ€§åˆ¥</th><th>è¦ä»‹è­·åº¦</th><th>æ“ä½œ</th></tr>
            </thead>
            <tbody id="patient-list-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="view-patient-detail" class="view-section hidden">
      <div class="flex justify-between items-center mb-4">
        <button class="btn btn-secondary" onclick="navigate('patients')">â† ä¸€è¦§ã«æˆ»ã‚‹</button>
        <button class="btn btn-primary" onclick="startNewRecord()">ï¼‹ æ–°è¦è¨˜éŒ²ä½œæˆ</button>
      </div>

      <div class="flex flex-col md:flex-row gap-4 mb-4">
        <div class="panel" style="flex:1;">
          <div class="panel-header"><span class="panel-title">åŸºæœ¬æƒ…å ±</span></div>
          <div id="detail-profile" class="text-sm" style="line-height:1.8;"></div>
        </div>
        <div class="panel" style="flex:2;">
          <div class="panel-header"><span class="panel-title">ãƒã‚¤ã‚¿ãƒ«æ¨ç§» (ç›´è¿‘)</span></div>
          <div style="height:200px;"><canvas id="chart-vitals"></canvas></div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header"><span class="panel-title">è¨ªå•ãƒ»è¨˜éŒ²å±¥æ­´</span></div>
        <div id="detail-history-list"></div>
      </div>
    </div>

    <div id="view-record-editor" class="view-section hidden">
      <div class="flex justify-between items-center mb-4">
        <button class="btn btn-secondary" onclick="closeRecordEditor()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <span class="font-bold text-gray" id="editor-mode-label">æ–°è¦è¨˜éŒ²</span>
      </div>

      <div class="flex flex-col md:flex-row gap-4">
        <div class="panel" style="flex:1; background:#f0f9ff; border-color:#bfdbfe;">
          <div class="panel-header"><span class="panel-title" style="color:#1e40af;">AI ã‚¢ã‚·ã‚¹ãƒˆ</span></div>
          <p class="text-sm text-gray mb-2">éŸ³å£°èªè­˜ã‚„ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€SOAPå½¢å¼ã§ä¸‹æ›¸ãã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
          <textarea id="ai-raw-input" placeholder="ä¾‹: ã€Œä»Šæ—¥ã¯ä½“æ¸©36.5åº¦ã€‚è¶³ã®ã‚€ãã¿å°‘ã—ã‚ã‚Šã€‚é£Ÿäº‹ã¯å…¨éƒ¨é£Ÿã¹ãŸã€‚å®¶æ—ã‹ã‚‰å¤œé–“ã®ãƒˆã‚¤ãƒ¬å›æ•°ã«ã¤ã„ã¦ç›¸è«‡ã‚ã‚Šã€‚ã€" style="height:120px;"></textarea>
          <div class="flex gap-2 mt-4">
            <button class="btn btn-secondary btn-sm" onclick="demoVoiceInput()">ğŸ¤ éŸ³å£°ãƒ‡ãƒ¢</button>
            <button class="btn btn-primary btn-sm" onclick="generateSOAP()">âœ¨ AIç”Ÿæˆå®Ÿè¡Œ</button>
          </div>
        </div>

        <div class="panel" style="flex:2;">
          <form onsubmit="saveRecord(event)">
            <input type="hidden" id="edit-visit-id">
            <div class="flex gap-4 mb-4">
              <div class="w-full">
                <label>è¨ªå•æ—¥æ™‚</label>
                <input type="datetime-local" id="edit-datetime" required>
              </div>
              <div class="w-full">
                <label>å®Ÿæ–½è€…</label>
                <input type="text" id="edit-staff" readonly>
              </div>
            </div>

            <label>ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³</label>
            <div class="flex gap-2 mb-4" style="flex-wrap:wrap;">
              <div style="flex:1; min-width:80px;"><input type="number" step="0.1" id="edit-temp" placeholder="ä½“æ¸© â„ƒ"></div>
              <div style="flex:1; min-width:80px;"><input type="number" id="edit-bp-sys" placeholder="BPä¸Š"></div>
              <div style="flex:1; min-width:80px;"><input type="number" id="edit-bp-dia" placeholder="BPä¸‹"></div>
              <div style="flex:1; min-width:80px;"><input type="number" id="edit-pulse" placeholder="è„ˆæ‹"></div>
              <div style="flex:1; min-width:80px;"><input type="number" id="edit-spo2" placeholder="SpO2"></div>
            </div>

            <div class="form-group">
              <label>S (Subjective) - ä¸»è¨´ãƒ»è‡ªè¦šç—‡çŠ¶</label>
              <textarea id="edit-soap-s"></textarea>
            </div>
            <div class="form-group">
              <label>O (Objective) - å®¢è¦³çš„æ‰€è¦‹</label>
              <textarea id="edit-soap-o"></textarea>
            </div>
            <div class="form-group">
              <label>A (Assessment) - è©•ä¾¡</label>
              <textarea id="edit-soap-a"></textarea>
            </div>
            <div class="form-group">
              <label>P (Plan) - è¨ˆç”»</label>
              <textarea id="edit-soap-p"></textarea>
            </div>

            <div class="text-right mt-4 border-t pt-4">
              <button type="submit" class="btn btn-primary btn-lg">ä¿å­˜ã—ã¦å®Œäº†</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div id="view-settings" class="view-section hidden">
      <div class="panel">
        <div class="panel-header"><span class="panel-title">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</span></div>
        <p class="text-sm text-gray mb-4">
          ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚
          ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ã¨ãƒ‡ãƒ¼ã‚¿ã¯æ¶ˆå¤±ã—ã¾ã™ã€‚
        </p>
        <button class="btn btn-danger" onclick="resetData()">ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ– (ãƒ‡ãƒ¢ç”¨ãƒªã‚»ãƒƒãƒˆ)</button>
      </div>
    </div>

  </div>
</div>

<script>
/**
 * ------------------------------------------------------------------
 * 1. Data Store & State Management (Based on EMR Logic)
 * ------------------------------------------------------------------
 */
const STORAGE_KEY = 'carenexus_full_v2';
const DEFAULT_USER = { id: 'user', name: 'Ns. å±±ç”°', role: 'nurse' };

// Initial Mock Data
function getInitialData() {
  const now = new Date();
  const yesterday = new Date(now.getTime() - 86400000);
  
  return {
    users: [
      { id: 'user', password: 'pass', name: 'Ns. å±±ç”°', role: 'nurse' },
      { id: 'admin', password: 'admin', name: 'ç®¡ç†è€…', role: 'admin' }
    ],
    patients: [
      { id: 'P001', name: 'ç”°ä¸­ å¤ªéƒ', kana: 'ã‚¿ãƒŠã‚« ã‚¿ãƒ­ã‚¦', gender: 'ç”·æ€§', dob: '1940-05-15', careLevel: 'è¦ä»‹è­·3', address: 'æ±äº¬éƒ½ä¸–ç”°è°·åŒº1-1', diagnosis: '2å‹ç³–å°¿ç—…, æœ¬æ…‹æ€§é«˜è¡€åœ§' },
      { id: 'P002', name: 'éˆ´æœ¨ ãƒãƒŠ', kana: 'ã‚¹ã‚ºã‚­ ãƒãƒŠ', gender: 'å¥³æ€§', dob: '1935-11-20', careLevel: 'è¦ä»‹è­·4', address: 'æ±äº¬éƒ½ä¸–ç”°è°·åŒº2-5', diagnosis: 'ã‚¢ãƒ«ãƒ„ãƒã‚¤ãƒãƒ¼å‹èªçŸ¥ç—‡' },
      { id: 'P003', name: 'ä½è—¤ å¥', kana: 'ã‚µãƒˆã‚¦ ã‚±ãƒ³', gender: 'ç”·æ€§', dob: '1950-02-10', careLevel: 'è¦ä»‹è­·1', address: 'æ±äº¬éƒ½ç›®é»’åŒº5-5', diagnosis: 'è„³æ¢—å¡å¾Œéºç—‡' }
    ],
    visits: [
      { 
        id: 'V101', patientId: 'P001', staffName: 'Ns. å±±ç”°', date: yesterday.toISOString(), status: 'completed',
        s: 'è¶³ã®ã‚€ãã¿ãŒå°‘ã—æ°—ã«ãªã‚‹ã€‚', o: 'ä¸‹è‚¢æµ®è…«(+)ã€çš®è†šãƒˆãƒ©ãƒ–ãƒ«ãªã—ã€‚', a: 'å¡©åˆ†æ‘‚å–éå¤šã®å¯èƒ½æ€§ã€‚ãƒã‚¤ã‚¿ãƒ«ã¯å®‰å®šã€‚', p: 'é£Ÿäº‹æŒ‡å°ã®ç¶™ç¶šã€‚æ¬¡å›ä½“é‡æ¸¬å®šã€‚',
        vitals: { temp: 36.5, bpSys: 138, bpDia: 85, pulse: 72, spo2: 98 }
      }
    ],
    currentUser: null
  };
}

let appState = { ...getInitialData() };
let currentPatientId = null;
let vitalsChartInstance = null;

// Load/Save Logic
function loadState() {
  const json = localStorage.getItem(STORAGE_KEY);
  if (json) {
    try {
      appState = JSON.parse(json);
    } catch(e) { console.error('Data load error', e); }
  }
}
function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
}
function resetData() {
  if(confirm('å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  }
}

/**
 * ------------------------------------------------------------------
 * 2. Authentication
 * ------------------------------------------------------------------
 */
function handleLogin(e) {
  e.preventDefault();
  const id = document.getElementById('login-id').value;
  const pw = document.getElementById('login-pw').value;
  
  const user = appState.users.find(u => u.id === id && u.password === pw);
  if (user) {
    appState.currentUser = user;
    saveState();
    initApp();
  } else {
    document.getElementById('login-error').style.display = 'block';
  }
}

function handleLogout() {
  appState.currentUser = null;
  saveState();
  location.reload();
}

/**
 * ------------------------------------------------------------------
 * 3. Navigation & View Routing
 * ------------------------------------------------------------------
 */
function initApp() {
  // Hide login, show app
  document.getElementById('login-overlay').classList.add('hidden');
  document.getElementById('app-main').classList.remove('hidden');
  
  // Header Info
  document.getElementById('display-username').textContent = appState.currentUser.name;
  
  // Load Data
  loadState();
  
  // Default View
  navigate('dashboard');
}

function navigate(viewName) {
  // Hide all sections
  document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

  // Show target
  const targetId = (viewName === 'patient-detail' || viewName === 'record-editor') 
    ? 'view-' + viewName // Sub-views don't have nav tabs
    : 'view-' + viewName;

  document.getElementById(targetId).classList.remove('hidden');

  // Activate Tab if exists
  const navTab = document.getElementById('nav-' + viewName);
  if (navTab) navTab.classList.add('active');

  // Logic triggers
  if (viewName === 'dashboard') renderDashboard();
  if (viewName === 'patients') renderPatientList();
}

/**
 * ------------------------------------------------------------------
 * 4. Dashboard Logic
 * ------------------------------------------------------------------
 */
function renderDashboard() {
  const d = new Date();
  document.getElementById('today-date').textContent = `${d.getMonth()+1}/${d.getDate()}`;
  
  const listEl = document.getElementById('schedule-list');
  listEl.innerHTML = '';

  // Demo: Show all patients as "Scheduled" for today if no visit exists today
  appState.patients.forEach(p => {
    // Check if visited today
    const todayStr = d.toISOString().slice(0,10);
    const hasVisit = appState.visits.find(v => v.patientId === p.id && v.date.startsWith(todayStr));
    
    const card = document.createElement('div');
    card.className = 'card flex justify-between items-center';
    card.innerHTML = `
      <div>
        <div class="font-bold">${p.name} æ§˜</div>
        <div class="text-sm text-gray">${p.address}</div>
      </div>
      <div>
        ${hasVisit 
          ? '<span class="tag tag-gray">å®Œäº†</span>' 
          : '<span class="tag tag-blue">äºˆå®šã‚ã‚Š</span>'}
      </div>
    `;
    card.onclick = () => openPatientDetail(p.id);
    listEl.appendChild(card);
  });
}

/**
 * ------------------------------------------------------------------
 * 5. Patient List & Detail Logic
 * ------------------------------------------------------------------
 */
function renderPatientList() {
  const tbody = document.getElementById('patient-list-tbody');
  tbody.innerHTML = '';
  const search = document.getElementById('patient-search').value.toLowerCase();

  appState.patients.forEach(p => {
    if (search && !p.name.includes(search) && !p.id.toLowerCase().includes(search)) return;
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.id}</td>
      <td class="font-bold">${p.name}</td>
      <td>${getAge(p.dob)}æ­³ / ${p.gender}</td>
      <td><span class="tag tag-green">${p.careLevel}</span></td>
      <td><button class="btn btn-secondary btn-sm" onclick="openPatientDetail('${p.id}')">è©³ç´°ãƒ»è¨˜éŒ²</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function getAge(dobStr) {
  const dob = new Date(dobStr);
  const now = new Date();
  return Math.floor((now - dob) / 31557600000);
}

function openPatientDetail(pid) {
  currentPatientId = pid;
  const p = appState.patients.find(x => x.id === pid);
  if (!p) return;

  // Render Basic Info
  document.getElementById('detail-profile').innerHTML = `
    <strong>æ°å:</strong> ${p.name} (${p.kana})<br>
    <strong>å¹´é½¢/æ€§åˆ¥:</strong> ${getAge(p.dob)}æ­³ / ${p.gender}<br>
    <strong>è¦ä»‹è­·åº¦:</strong> ${p.careLevel}<br>
    <strong>ä½æ‰€:</strong> ${p.address}<br>
    <strong>è¨ºæ–­å:</strong> ${p.diagnosis}
  `;

  // Render History
  const histEl = document.getElementById('detail-history-list');
  histEl.innerHTML = '';
  const pVisits = appState.visits
    .filter(v => v.patientId === pid)
    .sort((a,b) => new Date(b.date) - new Date(a.date));

  if(pVisits.length === 0) histEl.innerHTML = '<div class="text-sm text-gray p-2">è¨˜éŒ²ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>';

  pVisits.forEach(v => {
    const d = new Date(v.date);
    const dateStr = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`;
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `
      <div class="flex justify-between items-center mb-2">
        <span class="font-bold text-sm">${dateStr}</span>
        <span class="text-sm text-gray">æ‹…å½“: ${v.staffName}</span>
      </div>
      <div class="text-sm" style="white-space:pre-wrap; color:#374151;">S: ${v.s || ''}</div>
    `;
    div.onclick = () => openRecordEditor(v.id); // Edit mode
    histEl.appendChild(div);
  });

  // Render Chart
  renderChart(pVisits);

  navigate('patient-detail');
}

function renderChart(visits) {
  const ctx = document.getElementById('chart-vitals').getContext('2d');
  if (vitalsChartInstance) vitalsChartInstance.destroy();

  // Reverse to chrono order for chart
  const data = [...visits].reverse().filter(v => v.vitals && v.vitals.bpSys);
  
  vitalsChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.map(v => {
        const d = new Date(v.date);
        return `${d.getMonth()+1}/${d.getDate()}`;
      }),
      datasets: [
        { label: 'åç¸®æœŸè¡€åœ§', data: data.map(v => v.vitals.bpSys), borderColor: '#ef4444', tension: 0.1 },
        { label: 'æ‹¡å¼µæœŸè¡€åœ§', data: data.map(v => v.vitals.bpDia), borderColor: '#fca5a5', tension: 0.1 },
        { label: 'è„ˆæ‹', data: data.map(v => v.vitals.pulse), borderColor: '#3b82f6', tension: 0.1, hidden: true }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { y: { suggestedMin: 50, suggestedMax: 160 } }
    }
  });
}

/**
 * ------------------------------------------------------------------
 * 6. Record Editor & AI Logic
 * ------------------------------------------------------------------
 */
function startNewRecord() {
  document.getElementById('editor-mode-label').textContent = 'æ–°è¦è¨˜éŒ²ä½œæˆ';
  document.getElementById('edit-visit-id').value = '';
  
  // Defaults
  const now = new Date();
  // formatting for datetime-local: YYYY-MM-DDTHH:mm
  const localIso = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
  document.getElementById('edit-datetime').value = localIso;
  document.getElementById('edit-staff').value = appState.currentUser.name;
  
  // Clear fields
  ['edit-temp','edit-bp-sys','edit-bp-dia','edit-pulse','edit-spo2',
   'edit-soap-s','edit-soap-o','edit-soap-a','edit-soap-p','ai-raw-input']
   .forEach(id => document.getElementById(id).value = '');

  navigate('record-editor');
}

function openRecordEditor(visitId) {
  const v = appState.visits.find(x => x.id === visitId);
  if(!v) return;

  document.getElementById('editor-mode-label').textContent = 'éå»è¨˜éŒ²ã®ç·¨é›†';
  document.getElementById('edit-visit-id').value = v.id;
  
  // Fill data
  const d = new Date(v.date);
  const localIso = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
  document.getElementById('edit-datetime').value = localIso;
  document.getElementById('edit-staff').value = v.staffName;

  if(v.vitals) {
    document.getElementById('edit-temp').value = v.vitals.temp || '';
    document.getElementById('edit-bp-sys').value = v.vitals.bpSys || '';
    document.getElementById('edit-bp-dia').value = v.vitals.bpDia || '';
    document.getElementById('edit-pulse').value = v.vitals.pulse || '';
    document.getElementById('edit-spo2').value = v.vitals.spo2 || '';
  }

  document.getElementById('edit-soap-s').value = v.s || '';
  document.getElementById('edit-soap-o').value = v.o || '';
  document.getElementById('edit-soap-a').value = v.a || '';
  document.getElementById('edit-soap-p').value = v.p || '';
  document.getElementById('ai-raw-input').value = ''; // Clear AI input on edit

  navigate('record-editor');
}

function closeRecordEditor() {
  if (currentPatientId) {
    openPatientDetail(currentPatientId);
  } else {
    navigate('dashboard');
  }
}

// AI Functions
function demoVoiceInput() {
  const box = document.getElementById('ai-raw-input');
  box.value = '(éŸ³å£°èªè­˜ä¸­...)';
  setTimeout(() => {
    box.value = 'æœ¬æ—¥ã®è¨ªå•æ™‚ã€é¡”è‰²ã¯è‰¯å¥½ã€‚ãƒã‚¤ã‚¿ãƒ«ã¯è¡€åœ§130/80ã€ä½“æ¸©36.6åº¦ã€‚è¶³ã®ã‚€ãã¿ã¯è»½æ¸›ã—ã¦ã„ã‚‹ã€‚æœ¬äººã¯ã€Œæ˜¨æ—¥ã¯ã‚ˆãçœ ã‚ŒãŸã€ã¨è©±ã™ã€‚æœè–¬ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ç¢ºèªã—ã€æ®‹è–¬ãªã—ã€‚æ¬¡å›ã¯ãƒªãƒãƒ“ãƒªã®æ§˜å­ã‚’ç¢ºèªã™ã‚‹ã€‚';
  }, 1000);
}

function generateSOAP() {
  const raw = document.getElementById('ai-raw-input').value;
  if (!raw) return alert('ç”Ÿæˆå…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');

  // Simple rule-based mock AI for demo
  document.getElementById('edit-soap-s').value = 'AIç”Ÿæˆä¸­...';
  
  setTimeout(() => {
    // Fill Logic
    document.getElementById('edit-soap-s').value = `ãƒ»ã€Œæ˜¨æ—¥ã¯ã‚ˆãçœ ã‚ŒãŸã€ã¨ã®ç™ºè¨€ã‚ã‚Š\nãƒ»è¶³ã®ã‚€ãã¿è»½æ¸›ã®è‡ªè¦šã‚ã‚Š`;
    document.getElementById('edit-soap-o').value = `ãƒ»é¡”è‰²è‰¯ã€è¦šé†’æ¸…æ˜\nãƒ»ä¸‹è‚¢æµ®è…«: è»½æ¸›å‚¾å‘\nãƒ»æ®‹è–¬: ãªã—(ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹è‰¯å¥½)`;
    document.getElementById('edit-soap-a').value = `ãƒ»çŠ¶æ…‹å®‰å®šã—ã¦ãŠã‚Šã€æœè–¬ç®¡ç†ã‚‚ã§ãã¦ã„ã‚‹ã€‚\nãƒ»ç¡çœ çŠ¶æ³ã®æ”¹å–„ã«ã‚ˆã‚ŠQOLå‘ä¸ŠãŒè¦‹ã‚‰ã‚Œã‚‹ã€‚`;
    document.getElementById('edit-soap-p').value = `ãƒ»ç¾è¡Œãƒ—ãƒ©ãƒ³ç¶™ç¶š\nãƒ»æ¬¡å›è¨ªå•æ™‚ã€ãƒªãƒãƒ“ãƒªå®Ÿæ–½çŠ¶æ³ã®ç¢ºèª`;

    // Extract Vitals Mock
    if (raw.includes('130')) document.getElementById('edit-bp-sys').value = 130;
    if (raw.includes('80')) document.getElementById('edit-bp-dia').value = 80;
    if (raw.includes('36.6')) document.getElementById('edit-temp').value = 36.6;
    
    alert('AIã«ã‚ˆã‚‹SOAPç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸ');
  }, 1000);
}

function saveRecord(e) {
  e.preventDefault();
  const vid = document.getElementById('edit-visit-id').value;
  const isNew = !vid;

  const newRecord = {
    id: isNew ? 'V' + Date.now() : vid,
    patientId: currentPatientId,
    staffName: document.getElementById('edit-staff').value,
    date: new Date(document.getElementById('edit-datetime').value).toISOString(),
    status: 'completed',
    s: document.getElementById('edit-soap-s').value,
    o: document.getElementById('edit-soap-o').value,
    a: document.getElementById('edit-soap-a').value,
    p: document.getElementById('edit-soap-p').value,
    vitals: {
      temp: document.getElementById('edit-temp').value,
      bpSys: document.getElementById('edit-bp-sys').value,
      bpDia: document.getElementById('edit-bp-dia').value,
      pulse: document.getElementById('edit-pulse').value,
      spo2: document.getElementById('edit-spo2').value
    }
  };

  if (isNew) {
    appState.visits.push(newRecord);
  } else {
    const idx = appState.visits.findIndex(v => v.id === vid);
    if(idx !== -1) appState.visits[idx] = newRecord;
  }

  saveState();
  alert('è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
  closeRecordEditor();
}

// Start
document.addEventListener('DOMContentLoaded', () => {
  // Check if already logged in (Simple session persist)
  loadState();
  // Force login screen for demo purpose if not in session, or just allow auto-login logic
  // For this full demo, let's start at login screen unless we want to auto-login.
  // Uncomment below to force login every reload:
  // appState.currentUser = null; 
});
</script>
</body>
</html>
