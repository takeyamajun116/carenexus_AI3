<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>CareNexus AI : Complete Suite</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* ========== Base UI (CareNexus Design Language) ========== */
:root { 
    --primary: #2563eb; --primary-light: #dbeafe; 
    --danger: #ef4444; --danger-bg: #fee2e2;
    --success: #10b981; --success-bg: #d1fae5;
    --warning: #f59e0b; --warning-bg: #fef3c7;
    --text: #111827; --bg: #f3f4f6; --white: #ffffff;
    --admin: #4f46e5; /* 管理者モード用カラー */
}
body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Noto Sans JP", sans-serif; user-select: none; -webkit-tap-highlight-color: transparent; }
.app { max-width: 1200px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; padding-bottom: 80px; }

/* Components */
.btn { border:none; padding:10px 16px; border-radius:8px; font-weight:600; cursor:pointer; display:inline-flex; align-items:center; gap:6px; font-size:13px; transition:0.2s; text-decoration:none; }
.btn:active { transform:scale(0.98); }
.btn-primary { background:var(--primary); color:white; }
.btn-admin { background:var(--admin); color:white; }
.btn-danger { background:var(--danger); color:white; }
.btn-outline { background:white; border:1px solid #d1d5db; color:#374151; }
.btn-icon { width:36px; height:36px; padding:0; justify-content:center; border-radius:50%; }

input, textarea, select { width:100%; padding:12px; border:1px solid #d1d5db; border-radius:8px; background:#f9fafb; font-size:14px; margin-bottom:8px; }
input:focus, textarea:focus { outline:2px solid var(--primary); background:white; }

/* Header & Nav */
header { position:sticky; top:0; z-index:50; background:rgba(243,244,246,0.95); backdrop-filter:blur(10px); border-bottom:1px solid #e5e7eb; padding:12px 16px; display:flex; justify-content:space-between; align-items:center; }
.logo { font-weight:800; font-size:18px; color:var(--primary); display:flex; align-items:center; gap:8px; }
.admin-mode .logo { color: var(--admin); }

.tabs { display:flex; gap:6px; padding:8px 16px; overflow-x:auto; scrollbar-width:none; background:#e5e7eb; margin:0 16px 16px; border-radius:12px; }
.tab { padding:8px 16px; border-radius:8px; font-size:13px; font-weight:600; color:#6b7280; white-space:nowrap; cursor:pointer; transition:0.2s; }
.tab.active { background:white; color:var(--primary); box-shadow:0 1px 2px rgba(0,0,0,0.1); }
.admin-mode .tab.active { color: var(--admin); }

/* Layout Grid */
.grid-2 { display:grid; grid-template-columns:1fr; gap:16px; }
@media(min-width:768px){ .grid-2 { grid-template-columns:1fr 1fr; } }

.panel { background:white; border-radius:16px; padding:20px; box-shadow:0 1px 3px rgba(0,0,0,0.05); border:1px solid #e5e7eb; position:relative; }
.panel-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; font-weight:700; font-size:15px; }

/* Feature Specific UI */
/* Vitals Grid */
.vital-input-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(80px, 1fr)); gap:8px; }
.vital-box { text-align:center; }
.vital-box label { font-size:10px; color:#666; display:block; margin-bottom:2px; }

/* AI Suggestion Box (Billing Engine) */
.ai-suggestion { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border:1px solid #bfdbfe; border-radius:12px; padding:12px; margin-top:12px; animation: slideIn 0.3s ease; }
.ai-badge { font-size:10px; background:var(--primary); color:white; padding:2px 6px; border-radius:4px; margin-right:6px; }

/* Schema Canvas */
#schemaCanvas { border:1px solid #ddd; background:white; border-radius:8px; width:100%; height:300px; touch-action:none; cursor:crosshair; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 200"><path d="M50,10 Q60,10 60,20 L60,30 L80,30 L85,60 L60,60 L60,100 L70,180 L55,180 L50,110 L45,180 L30,180 L40,100 L40,60 L15,60 L20,30 L40,30 L40,20 Q40,10 50,10" fill="none" stroke="%23ccc" stroke-width="2"/></svg>'); background-repeat:no-repeat; background-position:center; background-size:contain; }

/* Admin Map */
.admin-map-container { height:300px; background:#e0e7ff; border-radius:12px; position:relative; overflow:hidden; display:flex; align-items:center; justify-content:center; }
.staff-pin { position:absolute; width:30px; height:30px; background:var(--admin); color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; border:2px solid white; box-shadow:0 4px 6px rgba(0,0,0,0.2); transition:0.3s; }
.staff-pin:hover { transform:scale(1.2); z-index:10; }

/* Risk Score Bar */
.risk-bar-bg { background:#eee; height:8px; border-radius:4px; overflow:hidden; margin-top:4px; }
.risk-bar-fill { height:100%; transition:1s ease-out; }

/* Animation */
@keyframes slideIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
.section { display:none; animation: slideIn 0.3s ease; padding:0 16px; }
.section.active { display:block; }

/* Security Overlay */
#authOverlay { position:fixed; inset:0; background:rgba(255,255,255,0.98); z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; }
</style>
</head>
<body>

<div id="authOverlay">
    <div style="font-size:40px; color:var(--primary); margin-bottom:20px;"><i class="fa-solid fa-user-nurse"></i></div>
    <h2 style="margin:0;">CareNexus AI</h2>
    <p style="color:#666; font-size:12px;">Complete Suite v2.0</p>
    
    <div style="margin-top:30px; width:280px;">
        <input type="password" id="passcode" placeholder="パスコード (1234)" style="text-align:center; font-size:18px; letter-spacing:4px;">
        <button class="btn btn-primary" style="width:100%; justify-content:center; margin-top:10px;" onclick="authenticate()">ログイン (生体認証)</button>
        <div style="text-align:center; margin-top:20px; font-size:12px; color:#666;">
            <i class="fa-solid fa-shield-halved"></i> 2要素認証(SMS)は設定済みです
        </div>
    </div>
</div>

<div class="app">
    <header id="mainHeader">
        <div class="logo" id="appLogo">
            <i class="fa-solid fa-heart-pulse"></i> CareNexus AI
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
            <button class="btn btn-outline btn-icon" onclick="toggleOffline()" title="オフラインモード"><i id="wifiIcon" class="fa-solid fa-wifi"></i></button>
            <button class="btn btn-outline btn-icon" onclick="toggleAuditMode()" title="実地指導モード"><i class="fa-solid fa-glasses"></i></button>
            <button class="btn btn-outline" style="font-size:11px; padding:6px 10px;" id="modeSwitchBtn" onclick="toggleAdminMode()">
                <i class="fa-solid fa-user-gear"></i> <span id="modeLabel">看護師</span>
            </button>
        </div>
    </header>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('visit')" id="tab-visit"><i class="fa-solid fa-route"></i> 訪問・ルート</div>
        <div class="tab" onclick="switchTab('record')" id="tab-record"><i class="fa-solid fa-file-medical"></i> 記録・AI算定</div>
        <div class="tab" onclick="switchTab('collab')" id="tab-collab"><i class="fa-solid fa-users"></i> 連携・MCS</div>
        <div class="tab" onclick="switchTab('admin')" id="tab-admin" style="display:none;"><i class="fa-solid fa-chart-pie"></i> 管理・分析</div>
    </div>

    <section id="sect-visit" class="section active">
        <div class="grid-2">
            <div class="panel">
                <div class="panel-head">
                    本日の訪問ルート (AI最適化済)
                    <span style="font-size:10px; background:#dcfce7; color:#166534; padding:2px 6px; border-radius:4px;">交通状況考慮中</span>
                </div>
                <div style="margin-bottom:10px;">
                    <button class="btn btn-outline" style="width:100%; justify-content:center;" onclick="alert('Googleマップアプリを起動し、ルートナビを開始します。')">
                        <i class="fa-solid fa-location-arrow"></i> ナビゲーション開始 (Google Maps)
                    </button>
                </div>
                <div id="visitList">
                    </div>
            </div>
            
            <div class="panel">
                <div class="panel-head">スケジュール・マッチング</div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                     <div style="flex:1; background:#f9fafb; padding:10px; border-radius:8px;">
                         <div style="font-size:11px; color:#666;">同行訪問管理</div>
                         <div style="font-weight:bold; font-size:13px;"><i class="fa-solid fa-user-group"></i> 新人A + ベテランB</div>
                     </div>
                     <div style="flex:1; background:#f9fafb; padding:10px; border-radius:8px;">
                         <div style="font-size:11px; color:#666;">スキルマッチング</div>
                         <div style="font-weight:bold; font-size:13px; color:var(--primary);"><i class="fa-solid fa-check-circle"></i> ストーマ処置対応</div>
                     </div>
                </div>
                <div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                    <div style="font-size:12px; font-weight:bold; color:var(--danger);">未提出アラート</div>
                    <div style="font-size:11px; margin-top:4px;">・田中様：計画書未作成 (期限あと2日)</div>
                </div>
            </div>
        </div>
    </section>

    <section id="sect-record" class="section">
        <div class="panel" style="margin-bottom:16px; border:2px solid var(--primary);">
            <div class="panel-head">
                <div>
                    対象：田中 太郎 (82)
                    <span style="font-size:11px; font-weight:normal; background:#eee; padding:2px 6px; border-radius:4px;">要介護3</span>
                </div>
                <button class="btn btn-outline" style="font-size:11px;" onclick="openManual()"><i class="fa-solid fa-book-medical"></i> 手順書参照</button>
            </div>

            <div style="margin-bottom:15px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                    <span style="font-size:12px; font-weight:bold;">バイタルサイン</span>
                    <button class="btn btn-primary" style="padding:4px 8px; font-size:10px;" onclick="simulateBluetooth()"><i class="fa-brands fa-bluetooth"></i> 機器連携</button>
                </div>
                <div class="vital-input-grid">
                    <div class="vital-box"><label>血圧(上)</label><input type="number" id="v_sbp" placeholder="130"></div>
                    <div class="vital-box"><label>血圧(下)</label><input type="number" id="v_dbp" placeholder="80"></div>
                    <div class="vital-box"><label>脈拍</label><input type="number" id="v_hr" placeholder="72"></div>
                    <div class="vital-box"><label>SpO2</label><input type="number" id="v_spo2" placeholder="98"></div>
                    <div class="vital-box"><label>体温</label><input type="number" id="v_kt" placeholder="36.5"></div>
                    <div class="vital-box"><label>体重(kg)</label><input type="number" id="v_weight" placeholder="60.5"></div>
                </div>
            </div>

            <div style="height:250px; margin-bottom:15px;">
                <canvas id="vitalChart"></canvas>
            </div>

            <div style="display:flex; gap:8px; margin-bottom:15px; overflow-x:auto;">
                <button class="btn btn-outline" style="font-size:11px;" onclick="alert('Barthel Index自動計算：85点 (自立)')">Barthel Index</button>
                <button class="btn btn-outline" style="font-size:11px;" onclick="alert('ブレーデンスケール：15点 (中リスク)')">褥瘡スケール</button>
                <button class="btn btn-outline" style="font-size:11px;" onclick="alert('MNA栄養評価：18点 (リスクあり)')">MNA栄養</button>
            </div>

            <div class="grid-2">
                <div>
                    <div class="panel-head" style="font-size:13px; margin-bottom:8px;">看護記録 (SOAP)</div>
                    <div style="display:flex; gap:8px; margin-bottom:8px;">
                         <button class="btn btn-outline" onclick="startVoiceInput()"><i class="fa-solid fa-microphone"></i> 音声入力</button>
                         <button class="btn btn-outline" onclick="loadNanda()"><i class="fa-solid fa-list"></i> 看護診断引用</button>
                    </div>
                    <textarea id="soapInput" rows="6" placeholder="記録を入力... (例: 仙骨部に発赤あり、処置実施。本人より痛みなしとの発言。)" oninput="analyzeBilling()"></textarea>
                    
                    <div style="display:flex; gap:8px; margin-top:8px;">
                        <button class="btn btn-outline" onclick="toggleSchema()"><i class="fa-solid fa-pen-nib"></i> シェーマ描画</button>
                        <button class="btn btn-outline" onclick="document.getElementById('fileUp').click()"><i class="fa-solid fa-video"></i> 動画/写真</button>
                        <input type="file" id="fileUp" hidden multiple>
                    </div>
                    <div id="schemaContainer" style="display:none; margin-top:10px;">
                        <div id="schemaCanvas"></div>
                        <button class="btn btn-outline" style="margin-top:4px; font-size:11px; width:100%;" onclick="clearSchema()">クリア</button>
                    </div>
                </div>

                <div>
                    <div class="ai-suggestion" id="billingEngine">
                        <div style="font-weight:bold; color:var(--primary); font-size:13px; margin-bottom:6px;">
                            <i class="fa-solid fa-robot"></i> AI算定加算エンジン
                        </div>
                        <div id="billingSuggestions" style="font-size:12px;">
                            <p style="color:#666;">記録を入力すると、算定可能な加算をAIが提案します。</p>
                        </div>
                    </div>

                    <div style="background:#fff3cd; border:1px solid #ffeeba; padding:10px; border-radius:8px; margin-top:10px; font-size:12px;">
                        <i class="fa-solid fa-triangle-exclamation" style="color:#b45309;"></i> <b>複雑加算アラート</b><br>
                        特別管理加算(ii)の算定要件を満たしています。<br>
                        指示書の有効期限を確認してください。
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="sect-collab" class="section">
        <div class="grid-2">
            <div class="panel">
                <div class="panel-head">MCS / 地域連携タイムライン</div>
                <div style="height:200px; overflow-y:auto; background:#f9fafb; border-radius:8px; padding:10px; border:1px solid #eee; margin-bottom:10px;">
                    <div style="margin-bottom:10px;">
                        <div style="font-size:10px; color:#666;">Dr. 佐藤 (主治医)</div>
                        <div style="background:white; padding:8px; border-radius:8px; display:inline-block; border:1px solid #ddd; font-size:12px;">
                            次回の訪問時に、褥瘡の状態写真を送ってください。
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:10px; color:#666;">自分</div>
                        <div style="background:#dbeafe; padding:8px; border-radius:8px; display:inline-block; font-size:12px;">
                            承知いたしました。シェーマと合わせて共有します。
                        </div>
                    </div>
                </div>
                <div style="display:flex; gap:6px;">
                    <input type="text" placeholder="メッセージ..." style="margin:0;">
                    <button class="btn btn-primary">送信</button>
                </div>
                <div style="margin-top:12px; display:flex; gap:8px;">
                    <button class="btn btn-outline" style="flex:1; font-size:11px;"><i class="fa-solid fa-video"></i> オンライン診療接続(Zoom)</button>
                    <button class="btn btn-outline" style="flex:1; font-size:11px;"><i class="fa-solid fa-envelope-open-text"></i> 家族連絡帳アプリ</button>
                </div>
            </div>

            <div class="panel">
                <div class="panel-head">事務・コンプライアンス</div>
                <button class="btn btn-outline" style="width:100%; margin-bottom:8px;" onclick="alert('スキャンカメラ起動：保険証をOCR解析します')">
                    <i class="fa-solid fa-expand"></i> 保険証/指示書 OCR読取
                </button>
                <button class="btn btn-outline" style="width:100%; margin-bottom:8px;" onclick="alert('サテライトAの利用者実績を集計しました')">
                    <i class="fa-solid fa-building-user"></i> サテライト一括管理
                </button>
            </div>
        </div>
    </section>

    <section id="sect-admin" class="section">
        <div style="background:var(--admin); color:white; padding:10px; border-radius:8px; margin-bottom:16px; font-size:13px;">
            <i class="fa-solid fa-lock"></i> <b>管理者モード起動中</b>：閲覧ログは監査証跡として保存されます。
        </div>

        <div class="grid-2">
            <div class="panel">
                <div class="panel-head">看護師リアルタイム位置情報 (GPS)</div>
                <div class="admin-map-container">
                    <div style="position:absolute; inset:0; opacity:0.3; background-image: radial-gradient(#ccc 1px, transparent 1px); background-size: 20px 20px;"></div>
                    <div class="staff-pin" style="top:40%; left:30%; background:#ef4444;" title="山田(移動中)">A</div>
                    <div class="staff-pin" style="top:60%; left:70%; background:#2563eb;" title="鈴木(訪問中)">B</div>
                    <div class="staff-pin" style="top:20%; left:50%; background:#10b981;" title="佐藤(休憩)">C</div>
                </div>
                <div style="margin-top:10px; font-size:12px; display:flex; gap:10px;">
                    <span style="display:flex; align-items:center; gap:4px;"><span style="width:8px; height:8px; background:#2563eb; border-radius:50%;"></span>訪問中</span>
                    <span style="display:flex; align-items:center; gap:4px;"><span style="width:8px; height:8px; background:#ef4444; border-radius:50%;"></span>移動中</span>
                </div>
            </div>

            <div class="panel">
                <div class="panel-head">スタッフ離職予兆スコア (AI分析)</div>
                <div style="font-size:11px; color:#666; margin-bottom:10px;">勤怠、記録時間、移動ログから疲労度を算出</div>
                
                <div style="margin-bottom:12px;">
                    <div style="display:flex; justify-content:space-between; font-size:13px;">
                        <span>山田 花子</span> <span style="color:var(--danger); font-weight:bold;">高リスク (85%)</span>
                    </div>
                    <div class="risk-bar-bg"><div class="risk-bar-fill" style="width:85%; background:var(--danger);"></div></div>
                    <div style="font-size:10px; color:#666; margin-top:2px;">理由: 残業過多(45h/月), 記録遅延増加</div>
                </div>

                <div style="margin-bottom:12px;">
                    <div style="display:flex; justify-content:space-between; font-size:13px;">
                        <span>鈴木 一郎</span> <span style="color:var(--warning); font-weight:bold;">注意 (60%)</span>
                    </div>
                    <div class="risk-bar-bg"><div class="risk-bar-fill" style="width:60%; background:var(--warning);"></div></div>
                    <div style="font-size:10px; color:#666; margin-top:2px;">理由: 訪問件数急増, 移動距離長</div>
                </div>
                
                <button class="btn btn-outline" style="width:100%; font-size:11px; margin-top:10px;">
                    <i class="fa-solid fa-file-chart-column"></i> スタッフ別生産性分析レポート出力
                </button>
            </div>
        </div>

        <div class="grid-2" style="margin-top:16px;">
            <div class="panel">
                <div class="panel-head">経営分析・予実管理</div>
                <div style="display:flex; justify-content:space-between; align-items:baseline;">
                    <div style="font-size:24px; font-weight:bold; color:var(--text);">¥ 5,240,000</div>
                    <div style="font-size:12px; color:var(--success);">達成率 92%</div>
                </div>
                <div style="height:10px; background:#eee; border-radius:5px; margin:10px 0; overflow:hidden;">
                    <div style="width:92%; height:100%; background:var(--success);"></div>
                </div>
                <div style="font-size:12px; color:#666;">今月の見込み売上 (シミュレーション値)</div>
            </div>

            <div class="panel">
                <div class="panel-head">リスク管理・BCP</div>
                <button class="btn btn-danger" style="width:100%; margin-bottom:8px;" onclick="alert('【BCP発動】\nトリアージリストを出力しました。\nオフラインデータをバックアップサーバーへ送信開始します。')">
                    <i class="fa-solid fa-house-tsunami"></i> 災害時BCPモード発動
                </button>
                <div style="display:flex; gap:8px;">
                    <button class="btn btn-outline" style="flex:1; font-size:11px;" onclick="alert('インシデントレポート作成画面を開きます')">事故報告書</button>
                    <button class="btn btn-outline" style="flex:1; font-size:11px;" onclick="alert('紛失端末のリモートロック信号を送信しました')">MDMロック</button>
                </div>
            </div>
        </div>
    </section>

</div>

<script>
// --- State & Config ---
let isAdmin = false;
let isOffline = false;
let isAuditMode = false;

// --- Chart Initialization (Vital Graph) ---
const ctx = document.getElementById('vitalChart').getContext('2d');
const vitalChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: ['12/10', '12/11', '12/12', '12/13', 'Current'],
        datasets: [
            { label: '収縮期血圧', data: [135, 138, 132, 128, null], borderColor: '#ef4444', yAxisID: 'y' },
            { label: '拡張期血圧', data: [82, 85, 80, 78, null], borderColor: '#f87171', borderDash:[5,5], yAxisID: 'y' },
            { label: '脈拍', data: [75, 78, 72, 70, null], borderColor: '#2563eb', yAxisID: 'y' },
            { label: 'SpO2', data: [98, 97, 98, 99, null], borderColor: '#10b981', yAxisID: 'y1' },
            { label: '体温', data: [36.5, 36.6, 36.4, 36.5, null], borderColor: '#f59e0b', yAxisID: 'y2' },
            { label: '体重', data: [60.0, 60.2, 60.1, 60.5, null], borderColor: '#8b5cf6', hidden:true }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        scales: {
            y: { position:'left', title:{display:true, text:'BP/Pulse'} },
            y1: { position:'right', min:90, max:100, grid:{drawOnChartArea:false}, title:{display:true, text:'SpO2'} },
            y2: { position:'right', min:35, max:40, grid:{drawOnChartArea:false}, title:{display:true, text:'Temp'} }
        }
    }
});

// --- Core Functions ---

// 1. Authenticate
function authenticate() {
    const code = document.getElementById('passcode').value;
    if(code === "1234") {
        document.getElementById('authOverlay').style.display = 'none';
    } else {
        alert("パスコードが違います(1234)");
    }
}

// 2. Tab Switch
function switchTab(tabId) {
    // Admin Guard
    if(tabId === 'admin' && !isAdmin) {
        alert("管理者権限が必要です。右上のアイコンから管理者モードに切り替えてください。");
        return;
    }
    
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    
    document.getElementById('tab-'+tabId).classList.add('active');
    document.getElementById('sect-'+tabId).classList.add('active');
}

// 3. Admin Mode Toggle
function toggleAdminMode() {
    isAdmin = !isAdmin;
    const body = document.body;
    const btn = document.getElementById('modeSwitchBtn');
    const label = document.getElementById('modeLabel');
    const tab = document.getElementById('tab-admin');

    if(isAdmin) {
        const pass = prompt("管理者パスワードを入力してください (admin)");
        if(pass !== "admin") {
            isAdmin = false;
            alert("認証失敗");
            return;
        }
        body.classList.add('admin-mode');
        btn.classList.add('btn-admin');
        btn.classList.remove('btn-outline');
        label.innerText = "管理者";
        tab.style.display = "block";
        switchTab('admin');
        // GPS & Risk Data Simulation
        alert("管理者モード: 全スタッフの位置情報と離職リスクスコアへのアクセスが許可されました。");
    } else {
        body.classList.remove('admin-mode');
        btn.classList.remove('btn-admin');
        btn.classList.add('btn-outline');
        label.innerText = "看護師";
        tab.style.display = "none";
        switchTab('visit');
    }
}

// 4. AI Billing Engine (Real-time Analysis)
function analyzeBilling() {
    const text = document.getElementById('soapInput').value;
    const container = document.getElementById('billingSuggestions');
    
    // Simple Keywords Matching Simulation
    let suggestions = [];
    if(text.includes("褥瘡") || text.includes("仙骨") || text.includes("処置")) {
        suggestions.push({name:"真皮を超える褥瘡の状態", point: "訪問看護記録書参照"});
    }
    if(text.includes("痛み") || text.includes("疼痛")) {
        suggestions.push({name:"ターミナルケア加算(緩和ケア)", point: "+2500単位/月"});
    }
    if(text.includes("緊急")) {
        suggestions.push({name:"緊急時訪問看護加算", point: "+574単位"});
    }

    if(suggestions.length > 0) {
        container.innerHTML = suggestions.map(s => `
            <div style="background:white; padding:8px; border-radius:6px; margin-top:6px; box-shadow:0 1px 2px rgba(0,0,0,0.05); display:flex; justify-content:space-between; align-items:center;">
                <div><span class="ai-badge">AI提案</span> <b>${s.name}</b></div>
                <div style="font-size:10px; font-weight:bold; color:var(--primary);">${s.point}</div>
            </div>
        `).join('');
    } else {
        container.innerHTML = `<p style="color:#666;">記録を入力すると、算定可能な加算をAIが提案します。</p>`;
    }
}

// 5. Bluetooth Simulation
function simulateBluetooth() {
    alert("Bluetooth機器接続中... [テルモ P2020]\n測定データを受信しました。");
    document.getElementById('v_sbp').value = 132;
    document.getElementById('v_dbp').value = 78;
    document.getElementById('v_hr').value = 74;
    document.getElementById('v_spo2').value = 98;
    document.getElementById('v_kt').value = 36.6;
    document.getElementById('v_weight').value = 60.5;
    
    // Add to chart
    const data = vitalChart.data.datasets;
    data[0].data[4] = 132;
    data[1].data[4] = 78;
    data[2].data[4] = 74;
    data[3].data[4] = 98;
    data[4].data[4] = 36.6;
    data[5].data[4] = 60.5;
    vitalChart.update();
}

// 6. Schema Logic
let isDrawing = false;
function toggleSchema() {
    const el = document.getElementById('schemaContainer');
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
}
// (Simple mouse tracking for demo visual - actual drawing requires canvas context listeners)
document.getElementById('schemaCanvas').addEventListener('mousemove', function(e) {
    if(e.buttons === 1) {
        // Just visual feedback cursor for demo
        this.style.cursor = 'crosshair';
        // In real app: ctx.lineTo(x, y); ctx.stroke();
    }
});
function clearSchema() { alert("シェーマをリセットしました"); }

// 7. Utils
function toggleOffline() {
    isOffline = !isOffline;
    const icon = document.getElementById('wifiIcon');
    if(isOffline) {
        icon.className = "fa-solid fa-cloud-bolt";
        icon.style.color = "var(--danger)";
        alert("オフラインモード：データはローカルに暗号化保存されます。");
    } else {
        icon.className = "fa-solid fa-wifi";
        icon.style.color = "inherit";
        alert("オンライン復帰：クラウド同期完了。");
    }
}

function toggleAuditMode() {
    isAuditMode = !isAuditMode;
    if(isAuditMode) {
        document.body.style.filter = "grayscale(10%)"; // Visual cue
        alert("【実地指導モード】\n不要なメモ書きを非表示にし、正規記録のみを表示します。");
    } else {
        document.body.style.filter = "none";
        alert("通常モードに戻りました。");
    }
}

function startVoiceInput() {
    alert("音声認識を開始します... (マイク許可)");
    setTimeout(() => {
        document.getElementById('soapInput').value += "仙骨部の発赤は昨日より改善傾向。洗浄後に軟膏塗布を実施。";
        analyzeBilling(); // Trigger AI
    }, 1500);
}

function loadNanda() {
    alert("NANDA-I 看護診断辞書を開きます。\n「皮膚統合性障害」を選択しました。");
}

// Visit List Generator
const visitData = [
    {name:"田中 太郎", time:"09:00", address:"新宿区西新宿", tag:"重点"},
    {name:"鈴木 花子", time:"11:30", address:"渋谷区代々木", tag:"リハビリ"},
    {name:"佐藤 次郎", time:"14:00", address:"港区赤坂", tag:"入浴"}
];
const vList = document.getElementById('visitList');
visitData.forEach(v => {
    vList.innerHTML += `
        <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid #eee;">
            <div>
                <div style="font-weight:bold;">${v.time} ${v.name}</div>
                <div style="font-size:11px; color:#666;"><i class="fa-solid fa-map-pin"></i> ${v.address}</div>
            </div>
            <span style="font-size:10px; background:#f3f4f6; padding:2px 6px; border-radius:4px;">${v.tag}</span>
        </div>
    `;
});

</script>
</body>
</html>
